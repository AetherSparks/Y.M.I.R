<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Y.M.I.R AI Dashboard - Microservices Architecture</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚀</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #f0f0f0;
            min-height: 100vh;
        }
        
        .content-wrapper {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #4070ff;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(45deg, #4070ff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #b0b0b0;
            margin: 10px 0 0 0;
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .status-card.healthy {
            border-color: rgba(34, 197, 94, 0.5);
        }
        
        .status-card.unhealthy {
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.healthy {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        .status-indicator.unhealthy {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        /* Main Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .camera-section {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .emotion-panel {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            color: #fff;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4070ff;
            display: inline-block;
        }
        
        /* Camera Controls */
        .camera-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(45deg, #4070ff, #00d4ff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(64, 112, 255, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }
        
        /* Video Container */
        .video-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #4070ff;
            min-height: 300px;
            align-items: center;
        }
        
        .video-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .video-placeholder {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            padding: 40px;
        }
        
        /* Emotion Display */
        .emotion-display {
            background: rgba(64, 112, 255, 0.1);
            border-radius: 12px;
            border-left: 4px solid #4070ff;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .emotion-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .emotion-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .emotion-label {
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .emotion-value {
            color: #4070ff;
            font-weight: 600;
        }
        
        .stable-emotion {
            background: rgba(34, 197, 94, 0.1);
            border-left-color: #22c55e;
            color: #22c55e;
        }
        
        /* Service Status */
        .service-status {
            background: rgba(40, 40, 40, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        /* Text Emotion Styles */
        .text-emotion-section {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(100, 100, 255, 0.2);
            padding: 25px;
            margin-top: 20px;
        }
        
        .chat-container {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            height: 500px; /* Expanded height to use empty space */
        }
        
        .chat-history {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px 15px 30px 15px; /* Extra bottom padding */
            flex: 1; /* Take all available space */
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid rgba(100, 100, 255, 0.1);
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth; /* Smooth scrolling */
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, rgba(64, 112, 255, 0.25), rgba(64, 112, 255, 0.15));
            border: 1px solid rgba(64, 112, 255, 0.3);
            margin-left: auto;
            text-align: right;
            box-shadow: 0 2px 8px rgba(64, 112, 255, 0.2);
        }
        
        .chat-message.bot {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
        }
        
        .chat-message-emotion {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #f0f0f0;
            font-size: 1rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #4070ff;
            box-shadow: 0 0 0 2px rgba(64, 112, 255, 0.2);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #4070ff, #22c55e);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 112, 255, 0.3);
        }
        
        .text-service-status {
            background: rgba(64, 112, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4070ff;
        }
        
        .text-service-status h4 {
            color: #4070ff;
            margin-bottom: 10px;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(64, 112, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4070ff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error States */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #ef4444;
            margin: 10px 0;
        }
        
        /* Advanced Controls Styling */
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .toggle-label:hover {
            background: rgba(255,255,255,0.05);
        }

        .toggle-label input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #4fd1c7;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-label input[type="checkbox"]:checked {
            background: #4fd1c7;
            border-color: #4fd1c7;
        }

        .toggle-label input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 2px;
            color: #1f2937;
            font-size: 14px;
            font-weight: bold;
        }

        .control-section {
            border-left: 3px solid #4fd1c7;
            padding-left: 15px;
        }

        /* 🎵 AI Music Discovery System - Hackathon Winner Design */
        .music-carousel-container {
            margin: 40px 0;
            padding: 35px;
            background: 
                radial-gradient(ellipse at top left, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at top right, rgba(96, 165, 250, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(30, 58, 138, 0.05) 0%, transparent 40%),
                linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(30, 58, 138, 0.95));
            border-radius: 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 
                0 30px 100px rgba(0, 0, 0, 0.6),
                0 0 60px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.12),
                inset 0 -1px 0 rgba(59, 130, 246, 0.05);
            overflow: hidden;
            backdrop-filter: blur(20px);
            cursor: grab;
            user-select: none;
        }

        .music-carousel-container:active {
            cursor: grabbing;
        }

        /* Carousel Controls */
        .carousel-controls {
            position: absolute;
            bottom: 15px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .carousel-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .carousel-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .carousel-btn.active {
            background: rgba(79, 209, 199, 0.3);
            border-color: #4fd1c7;
            color: #4fd1c7;
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.65em;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .music-carousel-container:hover .scroll-indicator {
            opacity: 1;
        }

        /* Animated Holographic Border - Dark Blue Theme */
        .music-carousel-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 30px;
            padding: 2px;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd, #1e3a8a);
            background-size: 400% 400%;
            animation: holographicBorder 6s ease infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
            z-index: -1;
        }

        @keyframes holographicBorder {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        /* Enhanced Floating Particles Effect - Dark Blue Theme */
        .music-carousel-container::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: calc(100% + 20px);
            height: calc(100% + 20px);
            background-image: 
                radial-gradient(circle at 15% 85%, rgba(59, 130, 246, 0.15) 0%, transparent 45%),
                radial-gradient(circle at 85% 15%, rgba(96, 165, 250, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 45% 35%, rgba(30, 58, 138, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 65% 75%, rgba(147, 197, 253, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 25% 25%, rgba(191, 219, 254, 0.06) 0%, transparent 35%),
                radial-gradient(circle at 75% 65%, rgba(59, 130, 246, 0.05) 0%, transparent 35%);
            animation: floatingParticles 12s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
            border-radius: 35px;
        }

        @keyframes floatingParticles {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg); 
                opacity: 1; 
                filter: blur(0px);
            }
            25% { 
                transform: translateY(-8px) translateX(3px) rotate(2deg); 
                opacity: 0.8; 
                filter: blur(0.5px);
            }
            50% { 
                transform: translateY(-15px) translateX(-2px) rotate(4deg); 
                opacity: 1; 
                filter: blur(1px);
            }
            75% { 
                transform: translateY(-10px) translateX(5px) rotate(-2deg); 
                opacity: 0.9; 
                filter: blur(0.3px);
            }
        }

        /* AI Music Header Styling */
        .music-carousel-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .ai-music-title {
            background: linear-gradient(135deg, #3b82f6, #60a5fa, #93c5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 15px 0;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
            letter-spacing: 1px;
            position: relative;
        }

        /* Enhanced AI Badge Styling - Dark Blue Neon Theme */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(59, 130, 246, 0.2));
            border: 2px solid transparent;
            border-radius: 30px;
            padding: 12px 24px;
            font-size: 15px;
            color: #60a5fa;
            font-weight: 700;
            margin: 15px 0 25px 0;
            backdrop-filter: blur(20px);
            box-shadow: 
                0 8px 32px rgba(59, 130, 246, 0.25),
                inset 0 1px 0 rgba(96, 165, 250, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .ai-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 30px;
            padding: 2px;
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd);
            background-size: 300% 300%;
            animation: badgeBorder 3s ease infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
            z-index: -1;
        }

        @keyframes badgeBorder {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .ai-badge:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(96, 165, 250, 0.3);
        }

        .ai-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #4fd1c7, #06d6a0);
            border-radius: 50%;
            position: relative;
            animation: aiPulse 2s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-icon::before {
            content: '🧠';
            font-size: 12px;
        }

        @keyframes aiPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(79, 209, 199, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 10px rgba(79, 209, 199, 0);
                transform: scale(1.1);
            }
        }


        /* Enhanced AI Status Indicator */
        .ai-status {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 58, 138, 0.7));
            border-radius: 25px;
            padding: 12px 20px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            backdrop-filter: blur(15px);
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.4),
                0 0 15px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(96, 165, 250, 0.1);
            font-size: 14px;
            font-weight: 500;
            color: #dbeafe;
            text-align: center;
            white-space: nowrap;
            min-width: 280px;
            transition: all 0.3s ease;
        }

        .status-indicator:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 6px 25px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(96, 165, 250, 0.2);
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #3b82f6, #1e40af);
            border-radius: 50%;
            animation: enhancedStatusPulse 2.5s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }

        @keyframes enhancedStatusPulse {
            0% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.8);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                opacity: 1;
            }
        }

        #aiStatus {
            font-size: 14px;
            color: #e2e8f0;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }

        .music-carousel {
            overflow: hidden;
            width: 100%;
            position: relative;
            height: 200px;
        }

        /* CSS Version 6.0 - Optimal Speed with Manual Controls */
        .music-track {
            display: flex;
            gap: 20px;
            animation: scroll-left 60s linear infinite;
            width: fit-content;
            transition: transform 0.3s ease;
        }

        .music-track.dragging {
            animation-play-state: paused !important;
            cursor: grabbing !important;
            transition: none !important;
        }

        .music-track.paused {
            animation-play-state: paused !important;
        }

        .music-carousel {
            cursor: grab;
        }

        .music-carousel:active {
            cursor: grabbing;
        }

        /* 🎨 ENHANCED AI SONG CARDS - STUNNING VISUAL DESIGN */
        .ai-song-card {
            min-width: 320px;
            height: 200px;
            border-radius: 20px;
            padding: 0;
            border: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .ai-song-card:hover {
            transform: translateY(-10px) scale(1.02) rotateX(5deg);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(255, 255, 255, 0.2),
                        0 0 40px rgba(255, 255, 255, 0.1);
            animation-play-state: paused;
        }

        /* Floating Music Icon */
        .floating-music-icon {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }

        .music-note {
            font-size: 18px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .music-wave {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(79, 209, 199, 0.4);
            border-radius: 50%;
            animation: pulse-ring 2s ease-in-out infinite;
        }

        /* Card Content */
        .card-content {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        /* Enhanced Song Title */
        .enhanced-song-title {
            position: relative;
            margin-bottom: 8px;
        }

        .title-text {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: block;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 220px;
        }

        .title-glow {
            position: absolute;
            bottom: -2px;
            left: 0;
            height: 2px;
            width: 0;
            background: linear-gradient(90deg, #4fd1c7, rgba(79, 209, 199, 0.5));
            transition: width 0.4s ease;
        }

        .ai-song-card:hover .title-glow {
            width: 100%;
        }

        /* Enhanced Artist */
        .enhanced-artist {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .artist-icon {
            font-size: 14px;
            opacity: 0.8;
        }

        .artist-text {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        /* Popularity Stats */
        .popularity-stats {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }

        .stat-bubble {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-bubble:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .stat-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Enhanced Play Button */
        .enhanced-play-btn {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 3;
        }

        .play-btn-inner {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .play-icon-enhanced {
            font-size: 18px;
            color: white;
            margin-left: 3px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .play-ripple {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            opacity: 0;
            transition: all 0.4s ease;
        }

        .enhanced-play-btn:hover .play-btn-inner {
            transform: scale(1.1);
            background: linear-gradient(135deg, rgba(79, 209, 199, 0.4), rgba(79, 209, 199, 0.2));
            box-shadow: 0 0 20px rgba(79, 209, 199, 0.4);
        }

        .enhanced-play-btn:active .play-ripple {
            transform: scale(1.2);
            opacity: 1;
        }

        .play-glow {
            position: absolute;
            width: 70px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .enhanced-play-btn:hover .play-glow {
            opacity: 1;
        }

        /* Card Shine Effect */
        .card-shine {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg) translateX(-100%);
            transition: transform 0.6s ease;
        }

        .ai-song-card:hover .card-shine {
            transform: rotate(45deg) translateX(100%);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        /* Legacy song-card styles for compatibility */
        .song-card {
            min-width: 280px;
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(79, 209, 199, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .song-info {
            margin-bottom: 15px;
        }

        .song-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #4fd1c7;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-artist {
            color: #fbbf24;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .song-duration {
            color: #9ca3af;
            font-size: 0.8em;
        }

        .song-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #4fd1c7, #06d6a0);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.2em;
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #06d6a0, #4fd1c7);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(79, 209, 199, 0.4);
        }

        .song-mood {
            background: rgba(79, 209, 199, 0.2);
            color: #4fd1c7;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            border: 1px solid rgba(79, 209, 199, 0.3);
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-25%);
            }
        }

        .music-track:hover {
            animation-play-state: paused;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .advanced-controls {
                margin: 15px 0 !important;
                padding: 10px !important;
            }

            .control-section > div {
                grid-template-columns: 1fr !important;
            }

            .music-carousel-container {
                margin: 20px 0;
                padding: 15px;
            }

            .song-card {
                min-width: 240px;
            }

            .music-track {
                animation-duration: 100s !important;
            }
        }

        /* Header Styles */
        .text-glow {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .nav-link:hover::after {
            width: 80%;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }
        
        .logo-container:hover .emoji-rotate {
            animation: rotate 0.5s ease;
        }
        
        .pulse-btn {
            animation: pulse 2s infinite;
        }
        
        .burger-menu {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
        }
        
        .burger-line {
            display: block;
            width: 100%;
            height: 2px;
            background-color: white;
            margin: 6px 0;
            transition: all 0.3s ease;
        }
        
        .burger-menu.active .burger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .burger-menu.active .burger-line:nth-child(2) {
            opacity: 0;
        }
        
        .burger-menu.active .burger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }
        
        @keyframes slideIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .mobile-link {
            animation: slideIn 0.3s ease forwards;
            opacity: 0;
        }
        
        .mobile-link:nth-child(1) { animation-delay: 0.1s; }
        .mobile-link:nth-child(2) { animation-delay: 0.2s; }
        .mobile-link:nth-child(3) { animation-delay: 0.3s; }
        .mobile-link:nth-child(4) { animation-delay: 0.4s; }
        .mobile-link:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        nav {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .nav-links {
            animation: fadeIn 0.7s ease forwards;
        }

        /* Professional Music Player Styles */
        .music-player-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            height: 480px;
            min-width: 300px;  /* 🔧 Minimum resize limits */
            min-height: 400px;
            max-width: 800px;  /* 🔧 Maximum resize limits */
            max-height: 1000px;
            background: linear-gradient(145deg, #1a1a2e 0%, #1e3a8a 50%, #0f172a 100%);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(59, 130, 246, 0.15);
            z-index: 10000;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.8) translateY(100px);
            resize: none; /* Disable default browser resize */
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            cursor: move;
            user-select: none;
        }

        .music-player-popup.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: all;
        }

        /* Wind Leaves Animation */
        .wind-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .wind-animation.active {
            opacity: 1;
        }

        .wind-particle {
            position: absolute;
            background: linear-gradient(45deg, #4fd1c7, #81e6d9);
            border-radius: 50% 85% 50% 85%;
            opacity: 0;
            animation: windFloat 2s ease-in-out infinite;
        }

        @keyframes windFloat {
            0% {
                opacity: 0;
                transform: translateX(-50px) translateY(50px) rotate(0deg);
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateX(450px) translateY(-100px) rotate(360deg);
            }
        }

        /* Player Content */
        .player-content {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 25px;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s ease;
        }

        .player-content.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* Close Button */
        .close-player-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-player-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Album Art Section */
        .album-art-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            cursor: grab; /* 🎯 Indicate draggable area */
            user-select: none; /* Prevent text selection during drag */
        }
        
        .album-art-section:active {
            cursor: grabbing; /* Show grabbing cursor when dragging */
        }

        /* 🔧 RESIZE HANDLES STYLES */
        .resize-handle {
            position: absolute;
            background: rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
            opacity: 0;
            pointer-events: none; /* Disable by default to prevent accidental triggers */
        }

        .music-player-popup:hover .resize-handle {
            opacity: 1; /* Show handles on hover */
            pointer-events: auto; /* Enable only when popup is hovered */
        }

        .resize-handle:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        /* Corner Resize Handles */
        .resize-corner {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .resize-nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Border Resize Handles */
        .resize-border {
            border-radius: 3px;
        }

        .resize-n { 
            top: -3px; left: 20px; right: 20px; 
            height: 6px; cursor: n-resize; 
        }
        .resize-s { 
            bottom: -3px; left: 20px; right: 20px; 
            height: 6px; cursor: s-resize; 
        }
        .resize-w { 
            left: -3px; top: 20px; bottom: 20px; 
            width: 6px; cursor: w-resize; 
        }
        .resize-e { 
            right: -3px; top: 20px; bottom: 20px; 
            width: 6px; cursor: e-resize; 
        }

        .album-art {
            width: 180px;
            height: 180px;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 15px;
            animation: albumRotate 20s linear infinite;
            animation-play-state: paused;
        }

        .album-art.playing {
            animation-play-state: running;
        }

        @keyframes albumRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .album-art::before {
            content: '♪';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        /* Song Info */
        .song-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .song-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .song-artist {
            font-size: 14px;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fd1c7, #81e6d9);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a0aec0;
        }

        /* Control Buttons */
        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .play-pause-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4fd1c7, #81e6d9);
            font-size: 20px;
            box-shadow: 0 5px 20px rgba(79, 209, 199, 0.4);
        }

        .play-pause-btn:hover {
            background: linear-gradient(135deg, #38b2ac, #4fd1c7);
            transform: scale(1.1);
        }

        /* Volume Control */
        .volume-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .volume-icon {
            color: #a0aec0;
            font-size: 16px;
        }

        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        /* Loading Animation - Musical Icon */
        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #3b82f6;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .music-loading-icon {
            font-size: 48px;
            animation: musicPulse 1.5s ease-in-out infinite;
            color: #60a5fa;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        @keyframes musicPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2) rotate(5deg); 
                opacity: 1;
            }
        }

        .loading-dots {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3b82f6;
            animation: loadingDots 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Minimized Player */
        .mini-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 80px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            z-index: 9999;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 15px;
        }

        .mini-player.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .mini-album-art {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            animation: miniAlbumRotate 20s linear infinite;
            animation-play-state: paused;
        }

        .mini-album-art.playing {
            animation-play-state: running;
        }

        @keyframes miniAlbumRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mini-album-art::before {
            content: '♪';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: rgba(255, 255, 255, 0.8);
        }

        .mini-song-info {
            flex: 1;
            min-width: 0;
            color: white;
        }

        .mini-song-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-song-artist {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mini-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .mini-control-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .mini-play-pause-btn {
            background: linear-gradient(135deg, #4fd1c7, #81e6d9);
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .mini-play-pause-btn:hover {
            background: linear-gradient(135deg, #38b2ac, #4fd1c7);
        }

        .mini-expand-btn {
            background: rgba(79, 209, 199, 0.2);
            border: 1px solid rgba(79, 209, 199, 0.4);
        }

        .mini-expand-btn:hover {
            background: rgba(79, 209, 199, 0.3);
        }

        .mini-close-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .mini-close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Progress bar for mini player */
        .mini-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #4fd1c7, #81e6d9);
            border-radius: 0 0 15px 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .music-player-popup {
                width: 320px;
                height: 420px;
                bottom: 10px;
                right: 10px;
            }

            .album-art {
                width: 140px;
                height: 140px;
            }

            .song-title {
                font-size: 16px;
            }

            .mini-player {
                width: 280px;
                height: 70px;
                bottom: 10px;
                right: 10px;
                padding: 8px;
                gap: 10px;
            }

            .mini-album-art {
                width: 50px;
                height: 50px;
            }

            .mini-song-title {
                font-size: 13px;
            }

            .mini-song-artist {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
<!-- HEADER START: Only include once -->
<nav class="bg-gradient-to-r from-black to-gray-800 text-white py-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-6">
        <!-- Desktop Navigation -->
        <div class="flex justify-between items-center">
            <!-- Logo with animation -->
            <a href="/" class="flex items-center space-x-2 group logo-container">
                <span class="text-3xl emoji-rotate">🎭</span>
                <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 group-hover:from-purple-500 group-hover:to-blue-400 transition-colors duration-300 text-glow">AI Emotion Detection</span>
            </a>

            <!-- Desktop Menu -->
            <div class="hidden md:flex items-center space-x-1 nav-links">
                <a href="/" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all font-medium relative overflow-hidden">Home</a>
                <a href="/ai_app" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all font-medium relative overflow-hidden">AI App</a>
                <a href="/about" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all font-medium relative overflow-hidden">About</a>
                <a href="/contact" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all font-medium relative overflow-hidden">Contact</a>
                <a href="/features" class="nav-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all font-medium relative overflow-hidden">Features</a>

                <a href="/ai_app" class="ml-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-all shadow-md pulse-btn">Try Demo</a>
            </div>

            <!-- Mobile menu button with animation -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-button" class="outline-none burger-menu">
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                    <span class="burger-line"></span>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden pt-4 pb-2 mobile-menu-container">
            <div class="flex flex-col space-y-2">
                <a href="/" class="mobile-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all">Home</a>
                <a href="/ai_app" class="mobile-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all">AI App</a>
                <a href="/about" class="mobile-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all">About</a>
                <a href="/contact" class="mobile-link px-4 py-2 rounded-lg hover:bg-blue-600 hover:bg-opacity-20 transition-all">Contact</a>
                <a href="/demo" class="mobile-link px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-all shadow-md text-center mt-2">Try Demo</a>
            </div>
        </div>
    </div>
</nav>
<!-- HEADER END -->
    <div class="content-wrapper">
        <div class="header">
            <h1>🚀 Y.M.I.R AI Dashboard</h1>
            <p>Microservices Architecture - Real-time Emotion Detection</p>
        </div>
        
        
        <!-- Main Dashboard -->
        <div class="dashboard-grid">
            <!-- Camera Section -->
            <div class="camera-section">
                <h2>📹 Real-Time Camera Feed</h2>
                
                <div class="camera-controls">
                    <button id="startBtn" onclick="startCamera()">Start Camera</button>
                    <button id="stopBtn" onclick="stopCamera()" class="btn-stop" disabled>Stop Camera</button>
                    <button onclick="refreshStatus()">Refresh Status</button>
                </div>

                <!-- 🎛️ Advanced Visual Controls -->
                <div class="advanced-controls" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #4fd1c7;">🎛️ Advanced Visual Controls</h3>
                    
                    <!-- MediaPipe Toggles -->
                    <div class="control-section" style="margin-bottom: 15px;">
                        <h4 style="color: #fbbf24; margin-bottom: 10px;">📐 MediaPipe Features</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_face_mesh" checked onchange="updateVisualSettings()">
                                <span>🔷 Face Mesh</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_body_pose" checked onchange="updateVisualSettings()">
                                <span>🧍 Body Pose</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_hand_tracking" checked onchange="updateVisualSettings()">
                                <span>✋ Hand Tracking</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_gaze_tracking" checked onchange="updateVisualSettings()">
                                <span>👁️ Gaze Tracking</span>
                            </label>
                        </div>
                    </div>

                    <!-- YOLO Model Controls -->
                    <div class="control-section" style="margin-bottom: 15px;">
                        <h4 style="color: #f97316; margin-bottom: 10px;">🎯 YOLO Object Detection</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_object_detection" checked onchange="updateVisualSettings()">
                                <span>📦 Object Detection</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_emotion_context" checked onchange="updateVisualSettings()">
                                <span>🎭 Emotion Context</span>
                            </label>
                            <div style="grid-column: span 2;">
                                <label style="color: #a3a3a3; font-size: 0.9em;">🎚️ Detection Confidence:</label>
                                <input type="range" id="confidence_threshold" min="0.1" max="0.9" step="0.05" value="0.25" 
                                       onchange="updateVisualSettings()" style="width: 100%; margin-left: 10px;">
                                <span id="confidence_value" style="color: #4fd1c7;">0.25</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Settings -->
                    <div class="control-section">
                        <h4 style="color: #ef4444; margin-bottom: 10px;">⚡ Performance & Quality</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div>
                                <label style="color: #a3a3a3; font-size: 0.9em;">📹 Video Quality:</label>
                                <select id="video_quality" onchange="updateVisualSettings()" style="width: 100%; padding: 5px; background: #1f2937; color: white; border: 1px solid #374151; border-radius: 4px;">
                                    <option value="720p">720p (Recommended)</option>
                                    <option value="1080p">1080p (High Quality)</option>
                                    <option value="480p">480p (Fast)</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #a3a3a3; font-size: 0.9em;">🎚️ Analysis Interval:</label>
                                <select id="analysis_interval" onchange="updateVisualSettings()" style="width: 100%; padding: 5px; background: #1f2937; color: white; border: 1px solid #374151; border-radius: 4px;">
                                    <option value="15">15 frames (2x per sec)</option>
                                    <option value="30" selected>30 frames (1x per sec)</option>
                                    <option value="60">60 frames (0.5x per sec)</option>
                                </select>
                            </div>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_quality_indicators" checked onchange="updateVisualSettings()">
                                <span>📊 Quality Indicators</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="toggle_fps_display" onchange="updateVisualSettings()">
                                <span>📈 FPS Display</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="video-container" id="videoContainer">
                    <div class="video-placeholder">
                        <div class="loading" id="loadingIndicator" style="display: none;"></div>
                        <p id="videoStatus">Click "Start Camera" to begin emotion detection</p>
                    </div>
                    <img id="videoFeed" style="display: none;" />
                </div>
                
                <div id="errorDisplay"></div>
                
                <!-- Emotion Display -->
                <div id="emotionDisplay" class="emotion-display" style="display: none;">
                    <h4>Current Emotions</h4>
                    <div id="emotionContent">
                        <p style="text-align: center; color: #666;">No emotions detected</p>
                    </div>
                    <div id="emotionLoading" class="loading" style="display: none;"></div>
                </div>
                
                <!-- Stable Emotion Display -->
                <div id="stableEmotion" class="emotion-display stable-emotion" style="display: none;">
                    <h4>Stable Emotion</h4>
                </div>
                
                <!-- Service Status -->
                <div class="service-status">
                    <h4>Face Service Status</h4>
                    <div id="emotionStatus">Checking face microservice status...</div>
                    <div id="serviceStatus">Loading...</div>
                </div>
            </div>
            
            
            <!-- Text Emotion Section -->
            <div class="text-emotion-section">
                <h2>💬 Text Emotion Analysis</h2>
                
                <div class="chat-container">
                    <div id="chatHistory" class="chat-history">
                        <div style="text-align: center; color: #666; margin: auto; font-style: italic;">
                            💬 Welcome to Y.M.I.R AI Chat<br>
                            <small style="color: #888;">Start a conversation to analyze emotions and get AI responses...</small>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Type your message here..." 
                               class="chat-input" maxlength="500">
                        <button id="sendMessageBtn" class="send-btn">Send</button>
                    </div>
                </div>
                
                <div id="textEmotionDisplay" class="emotion-display">
                    <h4>Latest Text Emotion</h4>
                    <div id="textEmotionContent">
                        <p style="text-align: center; color: #666;">No text analyzed yet...</p>
                    </div>
                </div>
                
                <div class="text-service-status">
                    <h4>Text Service Status</h4>
                    <div id="textServiceStatus">Checking text microservice status...</div>
                </div>
            </div>
        </div>

        <!-- 🎵 AI Music Discovery System -->
        <div class="music-carousel-container">
            <!-- AI Music Header -->
            <div class="music-carousel-header">
                <h2 class="ai-music-title">🎵 AI-Based Recommended Music</h2>
                <div class="ai-badge">
                    <div class="ai-icon"></div>
                    <span>Powered by Neural Emotion Analysis</span>
                </div>
                
                <!-- Status Indicator -->
                <div class="ai-status">
                    <div class="status-indicator">
                        <div class="pulse-dot"></div>
                        <span id="aiStatus">Discovering music based on your emotions...</span>
                    </div>
                </div>
            </div>
            
            <div class="music-carousel">
                <div class="music-track" id="musicTrack">
                    <!-- Initial loading placeholder -->
                    <div class="song-card" style="opacity: 0.7;">
                        <div class="song-info">
                            <div class="song-title">🎵</div>
                            <div class="song-artist">♪ ♫ ♪</div>
                            <div class="song-duration">♬</div>
                        </div>
                        <div class="song-controls">
                            <button class="play-btn" disabled>
                                <span class="play-icon">🎶</span>
                            </button>
                            <div class="song-mood">♩</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Carousel Controls -->
            <div class="carousel-controls">
                <div class="carousel-btn" id="pauseBtn" onclick="toggleCarouselAnimation()">⏸</div>
                <div class="carousel-btn" id="scrollLeftBtn" onclick="scrollCarouselLeft()">◀</div>
                <div class="carousel-btn" id="scrollRightBtn" onclick="scrollCarouselRight()">▶</div>
            </div>
            
            <!-- Scroll Indicator -->
            <div class="scroll-indicator">
                Drag to scroll • Use controls • Hover to pause
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let isRunning = false;
        let emotionUpdateInterval = null;
        let statusUpdateInterval = null;
        
        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const videoFeed = document.getElementById('videoFeed');
        const videoStatus = document.getElementById('videoStatus');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const emotionDisplay = document.getElementById('emotionDisplay');
        const emotionStatus = document.getElementById('emotionStatus');
        const emotionLoading = document.getElementById('emotionLoading');
        const stableEmotion = document.getElementById('stableEmotion');
        const serviceStatus = document.getElementById('serviceStatus');
        
        // API functions
        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                return await response.json();
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // Camera control functions
        async function startCamera() {
            showLoading(true);
            clearError();
            
            const result = await apiCall('/api/camera/start', 'POST');
            
            if (result.success) {
                isRunning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // Start video feed
                videoFeed.src = '/api/video_feed?' + new Date().getTime();
                videoFeed.style.display = 'block';
                videoStatus.style.display = 'none';
                
                // Start emotion updates
                startEmotionUpdates();
                
                showStatus('Camera started successfully!', 'success');
            } else {
                showError('Failed to start camera: ' + (result.error || result.message));
            }
            
            showLoading(false);
        }
        
        async function stopCamera() {
            showLoading(true);
            
            const result = await apiCall('/api/camera/stop', 'POST');
            
            if (result.success) {
                isRunning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // Stop high-performance video loop
                stopHighPerformanceVideoLoop();
                
                // Stop video feed
                const videoFeed = document.getElementById('videoFeed');
                if (videoFeed) {
                    videoFeed.src = '';
                    videoFeed.style.display = 'none';
                }
                
                const videoStatus = document.getElementById('videoStatus');
                if (videoStatus) {
                    videoStatus.style.display = 'block';
                    videoStatus.textContent = 'Camera stopped';
                }
                
                // Stop emotion updates
                stopEmotionUpdates();
                
                showStatus('Camera stopped successfully!', 'success');
            } else {
                showError('Failed to stop camera: ' + (result.error || result.message));
            }
            
            showLoading(false);
        }
        
        // Emotion monitoring - DISABLED (music carousel handles emotions)
        function startEmotionUpdates() {
            emotionLoading.style.display = 'none';
            emotionStatus.textContent = 'Emotions handled by music carousel';
            
            // REMOVED: Duplicate emotion calls - music carousel handles this
            console.log('💡 Emotion monitoring disabled - music carousel handles emotion detection');
        }
        
        function stopEmotionUpdates() {
            if (emotionUpdateInterval) {
                clearInterval(emotionUpdateInterval);
                emotionUpdateInterval = null;
            }
            
            emotionLoading.style.display = 'none';
            emotionStatus.textContent = 'Emotion analysis stopped';
            emotionDisplay.innerHTML = '<p style="text-align: center; color: #666;">Emotion analysis stopped</p>';
            stableEmotion.style.display = 'none';
        }
        
        function updateEmotionDisplay(data) {
            if (data.error) {
                emotionStatus.textContent = 'Error: ' + data.error;
                return;
            }
            
            emotionLoading.style.display = 'none';
            
            
            // Display current emotions
            if (data.current_emotions && Object.keys(data.current_emotions).length > 0) {
                let html = '<h4>Current Emotions</h4>';
                
                // Sort emotions by confidence
                const sortedEmotions = Object.entries(data.current_emotions)
                    .sort(([,a], [,b]) => b - a);
                
                for (const [emotion, confidence] of sortedEmotions) {
                    const percentage = (confidence * 100).toFixed(1);
                    html += `
                        <div class="emotion-item">
                            <span class="emotion-label">${emotion}</span>
                            <span class="emotion-value">${percentage}%</span>
                        </div>
                    `;
                }
                
                emotionDisplay.innerHTML = html;
            } else {
                emotionDisplay.innerHTML = '<p style="text-align: center; color: #666;">No emotions detected</p>';
            }
            
            // Display stable emotion
            if (data.stable_emotion) {
                const stable = data.stable_emotion;
                const confidence = (stable.confidence * 100).toFixed(1);
                
                stableEmotion.innerHTML = `
                    <h4>Stable Emotion</h4>
                    <div class="emotion-item">
                        <span class="emotion-label">${stable.emotion}</span>
                        <span class="emotion-value">${confidence}%</span>
                    </div>
                    <small>Last updated: ${new Date(stable.timestamp).toLocaleTimeString()}</small>
                `;
                stableEmotion.style.display = 'block';
            } else {
                stableEmotion.style.display = 'none';
            }
        }
        
        // Status monitoring
        async function refreshStatus() {
            const status = await apiCall('/api/face_status');
            updateServiceStatus(status);
        }
        
        function updateServiceStatus(status) {
            if (status.error) {
                serviceStatus.innerHTML = `<span style="color: #ef4444;">Error: ${status.error}</span>`;
                return;
            }
            
            const running = status.running ? '🟢' : '🔴';
            const detector = status.detector_loaded ? '🟢' : '🔴';
            
            serviceStatus.innerHTML = `
                Camera: ${running} ${status.running ? 'Running' : 'Stopped'}<br>
                Detector: ${detector} ${status.detector_loaded ? 'Loaded' : 'Not loaded'}<br>
                Session: ${status.session_id}<br>
                Readings: ${status.analytics?.total_readings || 0}
            `;
        }
        
        // UI helpers
        function showLoading(show) {
            loadingIndicator.style.display = show ? 'inline-block' : 'none';
        }
        
        function showError(message) {
            errorDisplay.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function clearError() {
            errorDisplay.innerHTML = '';
        }
        
        function showStatus(message, type) {
            console.log(`${type}: ${message}`);
        }
        
        // Text Emotion Analysis Functions
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const analyzeTextBtn = document.getElementById('analyzeTextBtn');
        const chatHistory = document.getElementById('chatHistory');
        const textEmotionContent = document.getElementById('textEmotionContent');
        const textServiceStatus = document.getElementById('textServiceStatus');
        
        async function analyzeText() {
            const text = chatInput.value.trim();
            if (!text) return;
            
            showLoading(true);
            
            try {
                const result = await apiCall('/api/text/analyze', 'POST', { text: text, is_user: true });
                
                if (result.success) {
                    displayTextEmotion(result.message);
                    addChatMessage(text, result.message.emotion_analysis, 'user');
                    chatInput.value = '';
                } else {
                    showError('Text analysis failed: ' + result.error);
                }
            } catch (error) {
                showError('Error analyzing text: ' + error.message);
            }
            
            showLoading(false);
        }
        
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // ⚡ PREVENT SPAM: Disable button immediately
            sendMessageBtn.disabled = true;
            sendMessageBtn.textContent = 'Sending...';
            chatInput.disabled = true;
            
            showLoading(true);
            
            try {
                const result = await apiCall('/api/text/chat', 'POST', { message: message });
                
                if (result.success) {
                    // Add user message
                    if (result.user_message && result.user_message.emotion_analysis) {
                        displayTextEmotion(result.user_message);
                        addChatMessage(result.user_message.content, result.user_message.emotion_analysis, 'user');
                    }
                    
                    // Add bot response
                    if (result.assistant_message) {
                        setTimeout(() => {
                            addChatMessage(result.assistant_message.content, null, 'bot');
                        }, 500);
                    }
                    
                    chatInput.value = '';
                } else {
                    showError('Chat failed: ' + result.error);
                }
            } catch (error) {
                showError('Error sending message: ' + error.message);
            }
            
            // ⚡ RE-ENABLE: After 1 second to prevent spam
            setTimeout(() => {
                sendMessageBtn.disabled = false;
                sendMessageBtn.textContent = 'Send';
                chatInput.disabled = false;
                chatInput.focus();
                showLoading(false);
            }, 1000);
        }
        
        function displayTextEmotion(message) {
            if (!message.emotion_analysis) {
                textEmotionContent.innerHTML = '<p style="color: #666;">No emotion analysis available</p>';
                return;
            }
            
            const emotion = message.emotion_analysis;
            const emotionEmojis = {
                'happy': '😊', 'sad': '😢', 'angry': '😡', 'fear': '😰',
                'surprise': '😮', 'disgust': '🤢', 'neutral': '😐'
            };
            
            const emoji = emotionEmojis[emotion.dominant_emotion] || '😐';
            
            textEmotionContent.innerHTML = `
                <div class="emotion-item">
                    <span>${emoji} <strong>${emotion.dominant_emotion.toUpperCase()}</strong></span>
                    <span>${(emotion.confidence * 100).toFixed(1)}%</span>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #888;">
                    Method: ${emotion.method || 'instant'} | Processing: ⚡ Instant
                </div>
                <div style="margin-top: 8px;">
                    ${emotion.all_emotions ? Object.entries(emotion.all_emotions)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 3)
                        .map(([em, score]) => `<span style="font-size: 0.8rem; margin-right: 10px;">${em}: ${(score * 100).toFixed(1)}%</span>`)
                        .join('') : 'Processing...'}
                </div>
            `;
        }
        
        function addChatMessage(text, emotionAnalysis, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            let emotionInfo = '';
            if (emotionAnalysis) {
                const emotion = emotionAnalysis.dominant_emotion;
                const confidence = (emotionAnalysis.confidence * 100).toFixed(1);
                const emoji = {
                    'happy': '😊', 'sad': '😢', 'angry': '😡', 'fear': '😰',
                    'surprise': '😮', 'disgust': '🤢', 'neutral': '😐'
                }[emotion] || '😐';
                
                emotionInfo = `<div class="chat-message-emotion">${emoji} ${emotion} (${confidence}%)</div>`;
            }
            
            messageDiv.innerHTML = `
                <div>${text}</div>
                ${emotionInfo}
            `;
            
            // Clear placeholder if it exists
            if (chatHistory.children.length === 1 && chatHistory.firstElementChild.tagName === 'P') {
                chatHistory.innerHTML = '';
            }
            
            chatHistory.appendChild(messageDiv);
            
            // Smooth auto-scroll to bottom with animation
            setTimeout(() => {
                chatHistory.scrollTo({
                    top: chatHistory.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        async function refreshTextStatus() {
            try {
                const status = await apiCall('/api/text_status');
                
                if (status.error) {
                    textServiceStatus.innerHTML = `<span style="color: #ef4444;">Error: ${status.error}</span>`;
                } else {
                    textServiceStatus.innerHTML = `
                        Status: ${status.running ? '🟢 Running' : '🔴 Stopped'}<br>
                        Models: ${status.models_loaded} loaded<br>
                        Conversation: ${status.conversation_length} messages<br>
                        Methods: ${status.available_methods ? status.available_methods.join(', ') : 'None'}
                    `;
                }
            } catch (error) {
                textServiceStatus.innerHTML = `<span style="color: #ef4444;">Connection error</span>`;
            }
        }
        
        // Event listeners for text emotion
        sendMessageBtn.addEventListener('click', sendChatMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // 🎛️ Advanced Visual Settings Management
        let currentVisualSettings = {
            show_face_mesh: true,
            show_body_pose: true,
            show_hand_tracking: true,
            show_gaze_tracking: true,
            show_object_detection: true,
            show_emotion_context: true,
            confidence_threshold: 0.25,
            video_quality: '720p',
            analysis_interval: 30,
            show_quality_indicators: true,
            show_fps_display: false
        };

        async function updateVisualSettings() {
            // Get all settings from UI
            currentVisualSettings = {
                show_face_mesh: document.getElementById('toggle_face_mesh').checked,
                show_body_pose: document.getElementById('toggle_body_pose').checked,
                show_hand_tracking: document.getElementById('toggle_hand_tracking').checked,
                show_gaze_tracking: document.getElementById('toggle_gaze_tracking').checked,
                show_object_detection: document.getElementById('toggle_object_detection').checked,
                show_emotion_context: document.getElementById('toggle_emotion_context').checked,
                confidence_threshold: parseFloat(document.getElementById('confidence_threshold').value),
                video_quality: document.getElementById('video_quality').value,
                analysis_interval: parseInt(document.getElementById('analysis_interval').value),
                show_quality_indicators: document.getElementById('toggle_quality_indicators').checked,
                show_fps_display: document.getElementById('toggle_fps_display').checked
            };

            // Update confidence display
            document.getElementById('confidence_value').textContent = currentVisualSettings.confidence_threshold;

            // Send settings to microservice
            try {
                const response = await fetch('/api/camera/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(currentVisualSettings)
                });
                
                if (response.ok) {
                    console.log('✅ Visual settings updated');
                } else {
                    console.warn('⚠️ Failed to update visual settings');
                }
            } catch (error) {
                console.error('❌ Error updating visual settings:', error);
            }
        }

        // 📹 HIGH PERFORMANCE Video Feed Management  
        let videoFeedInterval = null;
        let lastFrameTime = 0;
        const TARGET_FPS = 60; // Target 60 FPS
        const MIN_FRAME_INTERVAL = 1000 / TARGET_FPS; // ~16ms for 60 FPS

        function optimizeVideoFeed() {
            const video = document.getElementById('videoFeed');
            if (!video) return;

            // High performance frame timing
            const now = performance.now(); // More precise than Date.now()
            if (now - lastFrameTime < MIN_FRAME_INTERVAL) return; // Rate limiting for 60 FPS
            
            lastFrameTime = now;
            
            // Update video quality based on settings
            const quality = currentVisualSettings.video_quality;
            let qualityParam = '';
            switch(quality) {
                case '480p': qualityParam = '&quality=480'; break;
                case '720p': qualityParam = '&quality=720'; break;
                case '1080p': qualityParam = '&quality=1080'; break;
            }
            
            // Use timestamp for cache busting, but less frequent quality changes
            video.src = `/api/video_feed?t=${Math.floor(now)}${qualityParam}`;
        }

        // 🚀 60 FPS Video Stream using requestAnimationFrame
        let animationFrameId = null;
        let isVideoRunning = false;

        function startHighPerformanceVideoLoop() {
            if (isVideoRunning) return;
            isVideoRunning = true;
            
            function videoLoop() {
                if (!isVideoRunning) return;
                
                optimizeVideoFeed();
                animationFrameId = requestAnimationFrame(videoLoop);
            }
            
            videoLoop();
        }

        function stopHighPerformanceVideoLoop() {
            isVideoRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        // Enhanced camera start with optimization
        async function startCameraOptimized() {
            showLoading(true);
            clearError();
            
            try {
                // Apply visual settings before starting
                await updateVisualSettings();
                
                // Start camera with optimizations
                const result = await apiCall('/api/camera/start', 'POST');
                
                if (result.success) {
                    showStatus('Camera started successfully', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    
                    // Start optimized video feed
                    setTimeout(() => {
                        const videoContainer = document.getElementById('videoContainer');
                        videoContainer.innerHTML = `
                            <img id="videoFeed" 
                                 src="/api/video_feed?${Date.now()}" 
                                 alt="Video Feed"
                                 style="width: 100%; height: auto; border-radius: 8px;"
                                 onload="this.style.opacity=1"
                                 onerror="handleVideoError(this)"
                                 onabort="handleVideoError(this)">
                        `;
                        
                        // Start 60 FPS high-performance video loop
                        startHighPerformanceVideoLoop();
                    }, 1000);
                    
                    startEmotionUpdates();
                } else {
                    showError(result.message || 'Failed to start camera');
                }
            } catch (error) {
                showError('Camera start error: ' + error.message);
            }
            
            showLoading(false);
        }

        function handleVideoError(img) {
            console.warn('📹 Video feed error, retrying...');
            setTimeout(() => {
                if (img && img.parentNode) {
                    img.src = `/api/video_feed?${Date.now()}`;
                }
            }, 1000);
        }

        // Replace original startCamera with optimized version
        window.startCamera = startCameraOptimized;

        // 🎵 AI Music Carousel System - ONLY uses real therapeutic music data from CSV

        let currentlyPlaying = null;

        function createSongCard(song, index) {
            return `
                <div class="song-card" onclick="handleSongClick(${index})">
                    <div class="song-info">
                        <div class="song-title" title="${song.title}">${song.title}</div>
                        <div class="song-artist">${song.artist}</div>
                        <div class="song-duration">${song.duration}</div>
                    </div>
                    <div class="song-controls">
                        <button class="play-btn" onclick="playPauseSong(${index}, event)" data-playing="false">
                            <span class="play-icon">▶</span>
                        </button>
                        <div class="song-mood">${song.mood}</div>
                    </div>
                </div>
            `;
        }

        async function initializeMusicCarousel() {
            const musicTrack = document.getElementById('musicTrack');
            
            try {
                console.log('🎵 Loading AI-powered therapeutic music recommendations...');
                
                // 🚀 CALL THE REAL AI MUSIC API
                const response = await fetch('/api/music/recommendations?session_id=user123&limit=100');
                const data = await response.json();
                
                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    console.log('✅ AI Music API Success!');
                    console.log(`🎭 Emotion: ${data.emotion.dominant} (${data.emotion.confidence})`);
                    console.log(`🎵 Songs: ${data.recommendations.length}`);
                    console.log(`🤖 Multi-emotion: ${data.emotion.is_multi_emotion}`);
                    
                    // Convert API data to display format
                    const aiSongs = data.recommendations.map(track => ({
                        title: track.track_name,
                        artist: track.artist_name,
                        popularity: track.track_popularity,
                        artist_popularity: track.artist_popularity
                    }));
                    
                    // Store globally for click handlers
                    currentAISongs = aiSongs;
                    
                    // Create continuous carousel with AI songs
                    const allSongs = [...aiSongs, ...aiSongs]; // Duplicate for scrolling
                    musicTrack.innerHTML = allSongs.map((song, index) => createAISongCard(song, index % aiSongs.length)).join('');
                    
                    console.log('🎵 AI Music carousel loaded with', allSongs.length, 'therapeutic recommendations');
                    
                    // Update emotion display
                    updateEmotionDisplay(data.emotion);
                    
                } else {
                    console.log('⚠️ AI Music API failed - no recommendations available');
                    musicTrack.innerHTML = '<div class="song-card" style="opacity: 0.6;"><div class="song-info"><div class="song-title">🎵 No AI recommendations</div><div class="song-artist">Please check your emotion detection system</div></div></div>';
                }
                
            } catch (error) {
                console.error('❌ AI Music API error:', error);
                musicTrack.innerHTML = '<div class="song-card" style="opacity: 0.6;"><div class="song-info"><div class="song-title">⚠️ API Connection Error</div><div class="song-artist">Please refresh the page</div></div></div>';
            }
        }
        
        // Fallback functionality removed - ONLY AI data is used
        
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function createAISongCard(song, index) {
            // Original dark/blue theme gradients - keeping consistent with your design
            const darkGradients = [
                'linear-gradient(135deg, #1f2937, #374151)',
                'linear-gradient(135deg, #1e3a8a, #1f2937)', 
                'linear-gradient(135deg, #1f2937, #1e3a8a)',
                'linear-gradient(135deg, #374151, #1f2937)',
                'linear-gradient(135deg, #0f172a, #1e3a8a)',
                'linear-gradient(135deg, #1e3a8a, #0f172a)',
                'linear-gradient(135deg, #1f2937, #0f172a)',
                'linear-gradient(135deg, #374151, #1e3a8a)'
            ];
            
            const cardGradient = darkGradients[index % darkGradients.length];
            
            return `
                <div class="ai-song-card" onclick="handleAISongClick(${index})" style="background: ${cardGradient};">
                    <!-- Floating Music Icon -->
                    <div class="floating-music-icon">
                        <div class="music-note">♪</div>
                        <div class="music-wave"></div>
                    </div>
                    
                    <!-- Card Content -->
                    <div class="card-content">
                        <!-- Song Title with Glow Effect -->
                        <div class="enhanced-song-title" title="${song.title}">
                            <span class="title-text">${song.title}</span>
                            <div class="title-glow"></div>
                        </div>
                        
                        <!-- Artist Name with Icon -->
                        <div class="enhanced-artist">
                            <span class="artist-icon">🎤</span>
                            <span class="artist-text">${song.artist}</span>
                        </div>
                        
                        <!-- Popularity Stats with Animation -->
                        <div class="popularity-stats">
                            <div class="stat-bubble track-stat">
                                <div class="stat-icon" style="color: #4fd1c7;">🔥</div>
                                <div class="stat-value">${song.popularity || 0}</div>
                                <div class="stat-label">Track</div>
                            </div>
                            <div class="stat-bubble artist-stat">
                                <div class="stat-icon" style="color: #06d6a0;">⭐</div>
                                <div class="stat-value">${song.artist_popularity || 0}</div>
                                <div class="stat-label">Artist</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Play Button -->
                    <div class="enhanced-play-btn" onclick="playAISong(${index}, event)">
                        <div class="play-btn-inner">
                            <div class="play-icon-enhanced">▶</div>
                            <div class="play-ripple"></div>
                        </div>
                        <div class="play-glow"></div>
                    </div>
                    
                    <!-- Card Shine Effect -->
                    <div class="card-shine"></div>
                </div>
            `;
        }
        
        function updateEmotionDisplay(emotion) {
            // Update any emotion indicators on the page
            const emotionDisplay = document.querySelector('.current-emotion');
            if (emotionDisplay) {
                emotionDisplay.textContent = `Current Emotion: ${emotion.dominant} (${Math.round(emotion.confidence * 100)}%)`;
            }
        }

        // 🎠 CAROUSEL MANUAL CONTROLS
        function toggleCarouselAnimation() {
            const musicTrack = document.getElementById('musicTrack');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isCarouselPaused) {
                // Resume animation - RESET everything
                currentTransform = 0;
                musicTrack.style.transform = 'translateX(0px)';
                musicTrack.style.animation = 'scroll-left 60s linear infinite';
                musicTrack.classList.remove('paused');
                pauseBtn.textContent = '⏸';
                pauseBtn.classList.remove('active');
                isCarouselPaused = false;
                console.log('▶️ Animation resumed, reset to start');
            } else {
                // Pause animation
                musicTrack.style.animationPlayState = 'paused';
                musicTrack.classList.add('paused');
                pauseBtn.textContent = '▶';
                pauseBtn.classList.add('active');
                isCarouselPaused = true;
                console.log('⏸ Animation paused');
            }
        }

        function scrollCarouselLeft() {
            const musicTrack = document.getElementById('musicTrack');
            if (!musicTrack) return;
            
            const scrollAmount = 340; // Card width + gap
            
            // Only scroll left if we're not already at the start
            if (currentTransform < 0) {
                currentTransform += scrollAmount; // Move left (toward 0)
                
                // Don't scroll past start
                if (currentTransform > 0) currentTransform = 0;
                
                // DISABLE ANIMATION COMPLETELY for manual control
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update button states
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = '▶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('⬅️ Scrolled left, transform:', currentTransform);
            } else {
                console.log('⬅️ Already at start, cannot scroll left');
            }
        }

        function scrollCarouselRight() {
            const musicTrack = document.getElementById('musicTrack');
            if (!musicTrack) {
                console.log('❌ musicTrack not found');
                return;
            }
            
            const scrollAmount = 340; // Card width + gap
            
            // Calculate max scroll based on content width vs viewport width
            const totalWidth = currentAISongs.length * 340;
            const viewportWidth = window.innerWidth;
            const maxScroll = -(totalWidth - viewportWidth + 200); // Add some padding
            
            // Only scroll right if we haven't reached the end
            if (currentTransform > maxScroll) {
                currentTransform -= scrollAmount; // Move right (negative direction)
                
                // Don't scroll past end
                if (currentTransform < maxScroll) currentTransform = maxScroll;
                
                // DISABLE ANIMATION COMPLETELY for manual control
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update button states
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = '▶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('➡️ Scrolled right, transform:', currentTransform);
            } else {
                console.log('➡️ Already at end, cannot scroll right');
            }
        }

        // 🖱️ DRAG AND SWIPE FUNCTIONALITY  
        let dragListenersAttached = false;
        function initializeCarouselDragControls() {
            const container = document.querySelector('.music-carousel');
            const musicTrack = document.getElementById('musicTrack');
            
            if (!container || !musicTrack) {
                console.log('❌ Drag controls: Container or musicTrack not found');
                return;
            }

            // Remove existing listeners if any to prevent duplicates
            if (dragListenersAttached) {
                console.log('🔧 Removing old drag listeners');
                container.removeEventListener('mousedown', window.carouselMouseDown);
                document.removeEventListener('mousemove', window.carouselMouseMove);  
                document.removeEventListener('mouseup', window.carouselMouseUp);
            }

            console.log('✅ Initializing drag controls');
            dragListenersAttached = true;
            
            // Move variables to global scope for reinitialization
            window.carouselStartDragX = 0;
            window.carouselIsDragging = false;
            window.carouselStartTransform = 0;

            // Mouse events - Add debugging to see if events are attached
            console.log('🔧 Adding mouse event listeners to:', container);
            
            // Create global function references for removal
            window.carouselMouseDown = function(e) {
                console.log('🔧 MOUSEDOWN DETECTED on container!', e.target);
                startDrag(e);
            };
            window.carouselMouseMove = drag;
            window.carouselMouseUp = endDrag;
            
            container.addEventListener('mousedown', window.carouselMouseDown, { passive: false });
            document.addEventListener('mousemove', window.carouselMouseMove, { passive: false });
            document.addEventListener('mouseup', window.carouselMouseUp);

            // Touch events for mobile  
            container.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
            
            // Debug: Check if container is properly setup
            console.log('🔧 Drag container setup:', {
                container: container.className,
                musicTrack: musicTrack.id,
                containerRect: container.getBoundingClientRect(),
                trackRect: musicTrack.getBoundingClientRect(),
                currentAISongsLength: currentAISongs.length
            });
            
            // Test immediate functionality
            setTimeout(() => {
                console.log('🔧 Delayed check - currentAISongs length:', currentAISongs.length);
            }, 1000);

            function startDrag(e) {
                console.log('🔧 Start drag event fired, target:', e.target.className, 'tagName:', e.target.tagName);
                
                // Only prevent drag on actual button elements - allow drag everywhere else
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    console.log('❌ Drag blocked: clicked on button element');
                    return;
                }
                
                // Allow drag on all other elements including cards
                console.log('✅ Drag allowed on target:', e.target.className);
                
                // Get current transform from the element itself for accuracy
                const musicTrack = document.getElementById('musicTrack');
                const currentMatrix = window.getComputedStyle(musicTrack).transform;
                if (currentMatrix !== 'none') {
                    const values = currentMatrix.split('(')[1].split(')')[0].split(',');
                    currentTransform = parseFloat(values[4]) || 0;
                }
                
                window.carouselIsDragging = true;
                window.carouselStartDragX = e.clientX || e.touches[0].clientX;
                window.carouselStartTransform = currentTransform;
                
                container.style.cursor = 'grabbing';
                // DISABLE ANIMATION COMPLETELY during drag
                musicTrack.style.animation = 'none';
                musicTrack.classList.add('dragging');
                musicTrack.classList.add('paused');
                
                e.preventDefault();
                e.stopPropagation();
                console.log('🖱️ Drag started, startTransform:', window.carouselStartTransform, 'startDragX:', window.carouselStartDragX);
            }"}

            function drag(e) {
                if (!window.carouselIsDragging) {
                    // Don't log this constantly as it's normal during mouse movement
                    return;
                }
                e.preventDefault();
                
                const currentX = e.clientX || e.touches[0].clientX;
                const deltaX = currentX - window.carouselStartDragX;
                const newTransform = window.carouselStartTransform + deltaX;
                
                // Apply constraints (same logic as arrow buttons)
                const totalWidth = currentAISongs.length * 340;
                const viewportWidth = window.innerWidth;
                const maxScroll = -(totalWidth - viewportWidth + 200); // Add padding
                const constrainedTransform = Math.max(maxScroll, Math.min(0, newTransform));
                
                // DISABLE ANIMATION COMPLETELY during drag
                const musicTrack = document.getElementById('musicTrack');
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${constrainedTransform}px)`;
                currentTransform = constrainedTransform;
                
                console.log('🖱️ Dragging, deltaX:', deltaX, 'currentX:', currentX, 'startDragX:', window.carouselStartDragX, 'newTransform:', constrainedTransform);
            }"}

            function endDrag(e) {
                if (!window.carouselIsDragging) return;
                
                window.carouselIsDragging = false;
                const container = document.querySelector('.music-carousel');
                const musicTrack = document.getElementById('musicTrack');
                
                container.style.cursor = 'grab';
                musicTrack.classList.remove('dragging');
                musicTrack.classList.add('paused'); // Keep animation disabled
                
                // Update pause button state
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = '▶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('🖱️ Drag ended, transform:', currentTransform);
            }
        }
        
        // Global variable to store current AI songs
        let currentAISongs = [];
        
        // 🎠 Carousel Control Variables
        let isCarouselPaused = false;
        let isDragging = false;
        let startX = 0;
        let scrollOffset = 0;
        let currentTransform = 0;
        
        // 🔧 Function to sync currentTransform with actual DOM transform
        function syncCurrentTransform() {
            const musicTrack = document.getElementById('musicTrack');
            if (musicTrack) {
                const currentMatrix = window.getComputedStyle(musicTrack).transform;
                if (currentMatrix !== 'none') {
                    const values = currentMatrix.split('(')[1].split(')')[0].split(',');
                    currentTransform = parseFloat(values[4]) || 0;
                    console.log('🔄 Synced currentTransform:', currentTransform);
                }
            }
        }

        // 🔧 Debug function to test controls
        function testCarouselControls() {
            console.log('🔧 Testing carousel controls...');
            console.log('Elements found:');
            console.log('- musicTrack:', document.getElementById('musicTrack'));
            console.log('- music-carousel:', document.querySelector('.music-carousel'));
            console.log('- pauseBtn:', document.getElementById('pauseBtn'));
            console.log('- scrollLeftBtn:', document.getElementById('scrollLeftBtn'));
            console.log('- scrollRightBtn:', document.getElementById('scrollRightBtn'));
            console.log('- currentAISongs length:', currentAISongs.length);
            console.log('- currentTransform:', currentTransform);
        }

        // Expose to window for testing
        window.testCarouselControls = testCarouselControls;
        window.scrollCarouselLeft = scrollCarouselLeft;
        window.scrollCarouselRight = scrollCarouselRight;
        window.toggleCarouselAnimation = toggleCarouselAnimation;
        
        function handleAISongClick(index) {
            const song = currentAISongs[index % currentAISongs.length];
            console.log('🎵 AI Song clicked:', song.title, 'by', song.artist);
            console.log('🎯 GUARANTEE: This exact song will be played:', song.title);
            
            // Open the professional music player with THIS SPECIFIC AI song
            openMusicPlayer(song, index);
        }
        
        function playAISong(index, event) {
            event.stopPropagation();
            
            const song = currentAISongs[index % currentAISongs.length];
            console.log('▶️ Playing AI song:', song.title, 'by', song.artist);
            
            // Open the full music player instead of just showing notification
            openMusicPlayer(song, index);
        }

        // Old fallback music player functions removed - only AI songs are supported

        // ===== PROFESSIONAL MUSIC PLAYER FUNCTIONALITY =====
        let currentSongIndex = 0;
        let currentPlaylist = [];
        let audioPlayer = null;
        let isPlayerPlaying = false;

        function openMusicPlayer(song, index) {
            currentSongIndex = index;
            currentPlaylist = currentAISongs || [];
            
            console.log('🎵 Opening music player for:', song.title, 'by', song.artist);
            console.log('🎯 CONFIRMED: Playing this specific song:', song.title, 'by', song.artist);
            console.log('🎵 Current playlist length:', currentPlaylist.length);
            
            // Start wind animation and setup player simultaneously
            startWindAnimation();
            
            // Show the popup
            const popup = document.getElementById('musicPlayerPopup');
            popup.classList.add('visible');
            
            // Start setup immediately (don't wait for animation) - EXACTLY THIS SONG
            setupPlayer(song);
        }

        function startWindAnimation() {
            const windAnimation = document.getElementById('windAnimation');
            const particles = windAnimation.querySelectorAll('.wind-particle');
            
            // Position particles randomly
            particles.forEach((particle, index) => {
                const size = Math.random() * 8 + 4;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.top = Math.random() * 80 + 10 + '%';
                particle.style.left = '-20px';
                particle.style.animationDelay = (index * 0.2) + 's';
            });
            
            windAnimation.classList.add('active');
            
            // Hide wind animation after 1.5 seconds
            setTimeout(() => {
                windAnimation.classList.remove('active');
            }, 1500);
        }

        function setupPlayer(song) {
            const playerContent = document.getElementById('playerContent');
            const songTitle = document.getElementById('songTitle');
            const songArtist = document.getElementById('songArtist');
            const albumArt = document.getElementById('albumArt');
            
            // 🔧 CLEAR PREVIOUS AUDIO: Prevent audio reuse between different songs
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.src = '';
                audioPlayer.load();
                console.log(`🧹 Cleared previous audio before loading: ${song.title}`);
            }
            
            // Show player content
            playerContent.classList.add('visible');
            
            // Update song info
            songTitle.textContent = song.title;
            songArtist.textContent = song.artist;
            
            // Update album art gradient based on mood
            const moodColors = {
                'Happy': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'Sad': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'Energetic': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'Calm': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'Romantic': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'Motivational': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'Chill': 'linear-gradient(135deg, #96deda 0%, #50c9c3 100%)'
            };
            
            albumArt.style.background = moodColors[song.mood] || moodColors['Happy'];
            
            // Initialize audio player
            initializeAudioPlayer(song);
        }

        async function initializeAudioPlayer(song) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            // Show loading
            loadingMessage.style.display = 'block';
            playerContent.style.opacity = '0.5';
            
            try {
                console.log(`🎵 Initializing player for: ${song.title} by ${song.artist}`);
                
                const cacheResponse = await fetch(`/api/check_local_music?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`);
                const cacheData = await cacheResponse.json();
                
                if (cacheData.success && cacheData.cached) {
                    console.log(`⚡ Using cached audio: ${cacheData.source}`);
                    await setupAudioElement(cacheData.audio_url, cacheData.source);
                    await updateAlbumArt(song);
                    return;
                }
                
                console.log(`🔍 Fetching new audio for: ${song.title} by ${song.artist}`);
                
                const response = await fetch(`/api/get_audio?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`✅ Audio fetch response:`, data);
                
                if (data.success && data.audio_url) {
                    await setupAudioElement(data.audio_url, data.source);
                    await updateAlbumArt(song);
                } else {
                    throw new Error(data.error || 'Failed to get audio URL');
                }
                
            } catch (error) {
                console.error('❌ Error initializing audio:', error);
                handleAudioError(song);
            }
        }
        
        async function setupAudioElement(audioUrl, source) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            return new Promise((resolve, reject) => {
                // Setup audio element with real audio
                audioPlayer = document.getElementById('audioPlayer');
                
                // 🔧 PROPER CACHE CLEARING: Stop, clear, reset, then load new audio
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                audioPlayer.src = '';
                audioPlayer.load(); // Force browser to clear audio buffer completely
                
                // Add cache-busting parameter to ensure fresh audio load
                const cacheBustUrl = audioUrl + (audioUrl.includes('?') ? '&' : '?') + '_t=' + Date.now();
                audioPlayer.src = cacheBustUrl;
                
                console.log(`🔄 Loading fresh audio from ${source}: ${audioUrl}`);
                
                // Remove old event listeners
                audioPlayer.removeEventListener('loadedmetadata', () => {});
                audioPlayer.removeEventListener('timeupdate', updateProgress);
                audioPlayer.removeEventListener('ended', playNext);
                
                // Add new event listeners
                audioPlayer.addEventListener('loadedmetadata', () => {
                    loadingMessage.style.display = 'none';
                    playerContent.style.opacity = '1';
                    updateTotalTime();
                    console.log(`🎵 Audio loaded successfully from: ${source}`);
                    resolve();
                });
                
                audioPlayer.addEventListener('timeupdate', updateProgress);
                audioPlayer.addEventListener('ended', playNext);
                
                audioPlayer.addEventListener('error', (e) => {
                    console.error('❌ Audio playback error:', e);
                    reject(e);
                });
                
                // Auto-play when ready and preload next song
                audioPlayer.addEventListener('canplaythrough', () => {
                    console.log('🎵 Audio ready to play - starting automatically');
                    autoPlayAudio();
                    preloadNextSong();
                });
                
                // Set volume from slider
                const volumeSlider = document.getElementById('volumeSlider');
                if (volumeSlider) {
                    audioPlayer.volume = volumeSlider.value / 100;
                }
                
                // Load the audio
                audioPlayer.load();
            });
        }
        
        async function updateAlbumArt(song) {
            try {
                const response = await fetch(`/api/get_album_art?song=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`);
                const data = await response.json();
                
                if (data.success && data.image_url) {
                    const albumArt = document.getElementById('albumArt');
                    
                    // Create image element and set as background
                    const img = new Image();
                    img.onload = () => {
                        albumArt.style.backgroundImage = `url(${data.image_url})`;
                        albumArt.style.backgroundSize = 'cover';
                        albumArt.style.backgroundPosition = 'center';
                        // Remove the music note if image loads
                        albumArt.innerHTML = '';
                    };
                    img.src = data.image_url;
                }
            } catch (error) {
                console.log('⚠️ Could not load album art:', error);
                // Keep the default gradient background
            }
        }
        
        function handleAudioError(song) {
            const loadingMessage = document.getElementById('loadingMessage');
            const playerContent = document.getElementById('playerContent');
            
            // Hide loading and show error state
            loadingMessage.style.display = 'none';
            playerContent.style.opacity = '1';
            
            // Use fallback audio
            audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav';
            
            // Audio event listeners
            audioPlayer.addEventListener('loadedmetadata', () => {
                updateTotalTime();
            });
            
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', playNext);
            
            // Load the fallback audio
            audioPlayer.load();
            
            console.log('🔄 Using fallback audio for:', song.title);
        }

        function autoPlayAudio() {
            // Automatically start playing when audio is ready
            if (audioPlayer && audioPlayer.readyState >= 3) {
                const playPauseBtn = document.getElementById('playPauseBtn');
                const albumArt = document.getElementById('albumArt');
                
                audioPlayer.play().then(() => {
                    playPauseBtn.textContent = '⏸';
                    albumArt.classList.add('playing');
                    isPlayerPlaying = true;
                    console.log('🎵 Auto-play started successfully');
                }).catch(error => {
                    console.log('⚠️ Auto-play blocked by browser - user interaction required');
                    // Browser blocked auto-play, user will need to click play
                });
            }
        }
        
        function playPause() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            const albumArt = document.getElementById('albumArt');
            
            if (isPlayerPlaying) {
                audioPlayer.pause();
                playPauseBtn.textContent = '▶';
                albumArt.classList.remove('playing');
                isPlayerPlaying = false;
            } else {
                audioPlayer.play().then(() => {
                    playPauseBtn.textContent = '⏸';
                    albumArt.classList.add('playing');
                    isPlayerPlaying = true;
                }).catch(error => {
                    console.error('❌ Playback failed:', error);
                });
            }
        }

        function playNext() {
            currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
            const nextSong = currentPlaylist[currentSongIndex];
            setupPlayer(nextSong);
            if (isPlayerPlaying) {
                setTimeout(() => audioPlayer.play(), 500);
            }
        }

        function playPrevious() {
            currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            const prevSong = currentPlaylist[currentSongIndex];
            setupPlayer(prevSong);
            if (isPlayerPlaying) {
                setTimeout(() => audioPlayer.play(), 500);
            }
        }

        function updateProgress() {
            if (!audioPlayer) return;
            
            const progressFill = document.getElementById('progressFill');
            const currentTime = document.getElementById('currentTime');
            const miniProgress = document.getElementById('miniProgress');
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = progress + '%';
            
            // Update mini player progress
            if (miniProgress) {
                miniProgress.style.width = progress + '%';
            }
            
            currentTime.textContent = formatTime(audioPlayer.currentTime);
        }

        function updateTotalTime() {
            const totalTime = document.getElementById('totalTime');
            totalTime.textContent = formatTime(audioPlayer.duration);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function preloadNextSong() {
            // Preload the next song in background for instant switching
            const nextIndex = (currentSongIndex + 1) % currentPlaylist.length;
            const nextSong = currentPlaylist[nextIndex];
            
            // Check if next song is cached (don't download unnecessarily)
            fetch(`/api/check_local_music?song=${encodeURIComponent(nextSong.title)}&artist=${encodeURIComponent(nextSong.artist)}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.cached) {
                        console.log(`🔄 Preloading next song: ${nextSong.title}`);
                        // Trigger background download (don't wait for response)
                        fetch(`/api/get_audio?song=${encodeURIComponent(nextSong.title)}&artist=${encodeURIComponent(nextSong.artist)}`);
                    } else {
                        console.log(`⚡ Next song already cached: ${nextSong.title}`);
                    }
                })
                .catch(error => console.log('⚠️ Preload check failed:', error));
        }
        
        function closePlayer() {
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            
            // Hide main player
            playerContent.classList.remove('visible');
            popup.classList.remove('visible');
            
            // Show mini player if music is loaded
            if (audioPlayer && audioPlayer.src) {
                showMiniPlayer();
            }
        }
        
        function showMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            const miniSongTitle = document.getElementById('miniSongTitle');
            const miniSongArtist = document.getElementById('miniSongArtist');
            const miniAlbumArt = document.getElementById('miniAlbumArt');
            const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
            
            // Update mini player info
            const currentSong = currentPlaylist[currentSongIndex];
            if (currentSong) {
                miniSongTitle.textContent = currentSong.title;
                miniSongArtist.textContent = currentSong.artist;
                
                // Copy album art style from main player
                const mainAlbumArt = document.getElementById('albumArt');
                if (mainAlbumArt.style.backgroundImage) {
                    miniAlbumArt.style.backgroundImage = mainAlbumArt.style.backgroundImage;
                    miniAlbumArt.style.backgroundSize = 'cover';
                    miniAlbumArt.style.backgroundPosition = 'center';
                    miniAlbumArt.innerHTML = '';
                } else {
                    miniAlbumArt.style.background = mainAlbumArt.style.background;
                }
            }
            
            // Update play/pause button
            miniPlayPauseBtn.textContent = isPlayerPlaying ? '⏸' : '▶';
            
            // Sync album art rotation
            if (isPlayerPlaying) {
                miniAlbumArt.classList.add('playing');
            } else {
                miniAlbumArt.classList.remove('playing');
            }
            
            // Show mini player
            miniPlayer.classList.add('visible');
        }
        
        function hideMiniPlayer() {
            const miniPlayer = document.getElementById('miniPlayer');
            miniPlayer.classList.remove('visible');
        }
        
        function expandMiniPlayer() {
            // Hide mini player and show main player
            hideMiniPlayer();
            
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            
            popup.classList.add('visible');
            playerContent.classList.add('visible');
        }
        
        function stopMusic() {
            console.log('🔇 Stopping music and cleaning up...');
            
            if (audioPlayer) {
                // Stop all playback
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                
                // Remove all event listeners to prevent any continued playback
                audioPlayer.removeEventListener('timeupdate', updateProgress);
                audioPlayer.removeEventListener('ended', playNext);
                audioPlayer.removeEventListener('loadedmetadata', () => {});
                audioPlayer.removeEventListener('error', () => {});
                audioPlayer.removeEventListener('canplaythrough', () => {});
                
                // Remove the audio source completely
                audioPlayer.src = '';
                audioPlayer.load(); // Force reload to clear buffer
                
                // Update player state
                isPlayerPlaying = false;
                
                // Update UI elements
                const playPauseBtn = document.getElementById('playPauseBtn');
                const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
                
                if (playPauseBtn) playPauseBtn.textContent = '▶';
                if (miniPlayPauseBtn) miniPlayPauseBtn.textContent = '▶';
                
                // Reset progress bars
                const progressFill = document.getElementById('progressFill');
                const miniProgress = document.getElementById('miniProgress');
                const currentTime = document.getElementById('currentTime');
                const totalTime = document.getElementById('totalTime');
                
                if (progressFill) progressFill.style.width = '0%';
                if (miniProgress) miniProgress.style.width = '0%';
                if (currentTime) currentTime.textContent = '0:00';
                if (totalTime) totalTime.textContent = '0:00';
                
                console.log('🔇 Audio stopped and all listeners removed');
            }
            
            // Hide both players
            const popup = document.getElementById('musicPlayerPopup');
            const playerContent = document.getElementById('playerContent');
            popup.classList.remove('visible');
            playerContent.classList.remove('visible');
            hideMiniPlayer();
            
            // Clear session storage for player state
            sessionStorage.removeItem('musicPlayerVisible');
            sessionStorage.removeItem('miniPlayerVisible');
            
            console.log('🔇 Music player completely stopped');
        }

        // Mini player functions
        function miniPlayPause() {
            playPause();
            
            // Update mini player button
            const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
            const miniAlbumArt = document.getElementById('miniAlbumArt');
            
            miniPlayPauseBtn.textContent = isPlayerPlaying ? '⏸' : '▶';
            
            if (isPlayerPlaying) {
                miniAlbumArt.classList.add('playing');
            } else {
                miniAlbumArt.classList.remove('playing');
            }
        }
        
        function miniPlayNext() {
            playNext();
            // Update mini player info after song change
            setTimeout(() => {
                if (document.getElementById('miniPlayer').classList.contains('visible')) {
                    showMiniPlayer();
                }
            }, 500);
        }
        
        function miniPlayPrevious() {
            playPrevious();
            // Update mini player info after song change
            setTimeout(() => {
                if (document.getElementById('miniPlayer').classList.contains('visible')) {
                    showMiniPlayer();
                }
            }, 500);
        }

        // Setup event listeners for music player
        document.addEventListener('DOMContentLoaded', () => {
            // Main player controls
            document.getElementById('closePlayerBtn').addEventListener('click', closePlayer);
            document.getElementById('playPauseBtn').addEventListener('click', playPause);
            document.getElementById('nextBtn').addEventListener('click', playNext);
            document.getElementById('prevBtn').addEventListener('click', playPrevious);
            
            // Mini player controls
            document.getElementById('miniPlayPauseBtn').addEventListener('click', miniPlayPause);
            document.getElementById('miniNextBtn').addEventListener('click', miniPlayNext);
            document.getElementById('miniPrevBtn').addEventListener('click', miniPlayPrevious);
            document.getElementById('miniExpandBtn').addEventListener('click', expandMiniPlayer);
            document.getElementById('miniCloseBtn').addEventListener('click', stopMusic);
            
            // Progress bar click
            document.getElementById('progressBar').addEventListener('click', (e) => {
                if (!audioPlayer) return;
                const rect = e.target.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;
                audioPlayer.currentTime = percentage * audioPlayer.duration;
            });
            
            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                if (audioPlayer) {
                    audioPlayer.volume = e.target.value / 100;
                }
            });
        });

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#4fd1c7'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                font-size: 0.9em;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialize music carousel immediately (before DOM fully loads)
        function initCarouselEarly() {
            const musicTrack = document.getElementById('musicTrack');
            if (musicTrack) {
                initializeMusicCarousel();
                initializeCarouselDragControls();
                initializeWheelScroll();
                
                // 🔄 AUTO-REFRESH MUSIC EVERY 30 SECONDS
                setInterval(() => {
                    console.log('🔄 Auto-refreshing AI music recommendations...');
                    initializeMusicCarousel();
                }, 30000); // 30 seconds
            } else {
                // Retry in 100ms if element not ready
                setTimeout(initCarouselEarly, 100);
            }
        }

        // 🎡 WHEEL SCROLL SUPPORT
        function initializeWheelScroll() {
            const container = document.querySelector('.music-carousel');
            if (!container) return;

            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                const musicTrack = document.getElementById('musicTrack');
                if (!musicTrack) return;
                
                const scrollSpeed = e.deltaY > 0 ? -80 : 80; // Faster scroll, deltaY > 0 = scroll down = move right
                currentTransform += scrollSpeed;
                
                // Apply constraints
                const totalWidth = currentAISongs.length * 340;
                const viewportWidth = window.innerWidth;
                const maxScroll = -(totalWidth - viewportWidth);
                currentTransform = Math.max(maxScroll, Math.min(0, currentTransform));
                
                // DISABLE ANIMATION COMPLETELY for wheel scroll
                musicTrack.style.animation = 'none';
                musicTrack.style.transform = `translateX(${currentTransform}px)`;
                musicTrack.classList.add('paused');
                
                // Update pause button
                isCarouselPaused = true;
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = '▶';
                    pauseBtn.classList.add('active');
                }
                
                console.log('🎡 Wheel scroll, transform:', currentTransform);
            });
        }

        // Header initialization function
        function initializeHeader() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                    this.classList.toggle('active');
                    
                    // Reset animations when toggling menu
                    const mobileLinks = document.querySelectorAll('.mobile-link');
                    mobileLinks.forEach(link => {
                        link.style.animation = 'none';
                        link.offsetHeight; // Trigger reflow
                        link.style.animation = null;
                    });
                });
            }
            
            // Add subtle hover animations to nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });
                
                link.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        }


        // 🎵 Draggable Music Player - Snap to 4 Corners
        function makeMusicPlayerDraggable() {
            const player = document.getElementById('musicPlayerPopup');
            if (!player) return;

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            function dragStart(e) {
                // 🎯 RESTRICT DRAG: Only allow dragging from album art area
                const albumArtSection = e.target.closest('.album-art-section');
                const albumArt = e.target.closest('#albumArt');
                
                if (!albumArtSection && !albumArt) {
                    // Not dragging from album art area, ignore
                    return;
                }

                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                isDragging = true;
                player.style.transition = 'none';
                player.style.cursor = 'grabbing';
                console.log('🎯 Drag started from album art area');
            }

            function dragEnd(e) {
                if (!isDragging) return;
                
                isDragging = false;
                player.style.transition = 'all 0.3s ease';
                player.style.cursor = 'auto'; /* Reset cursor */
                
                // Snap to nearest corner
                snapToCorner();
                
                console.log('🎯 Drag ended - snapped to corner');
            }

            function drag(e) {
                if (!isDragging) return;

                e.preventDefault();

                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                xOffset = currentX;
                yOffset = currentY;

                player.style.transform = `translate(${currentX}px, ${currentY}px)`;
            }

            function snapToCorner() {
                const rect = player.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const playerWidth = rect.width;
                const playerHeight = rect.height;

                const centerX = rect.left + playerWidth / 2;
                const centerY = rect.top + playerHeight / 2;

                let targetX, targetY;

                // Determine which corner is closest
                if (centerX < windowWidth / 2 && centerY < windowHeight / 2) {
                    // Top-left corner
                    targetX = 20;
                    targetY = 20;
                    player.style.left = targetX + 'px';
                    player.style.top = targetY + 'px';
                    player.style.right = 'auto';
                    player.style.bottom = 'auto';
                } else if (centerX >= windowWidth / 2 && centerY < windowHeight / 2) {
                    // Top-right corner
                    targetX = 20;
                    targetY = 20;
                    player.style.right = targetX + 'px';
                    player.style.top = targetY + 'px';
                    player.style.left = 'auto';
                    player.style.bottom = 'auto';
                } else if (centerX < windowWidth / 2 && centerY >= windowHeight / 2) {
                    // Bottom-left corner
                    targetX = 20;
                    targetY = 20;
                    player.style.left = targetX + 'px';
                    player.style.bottom = targetY + 'px';
                    player.style.right = 'auto';
                    player.style.top = 'auto';
                } else {
                    // Bottom-right corner (default)
                    targetX = 20;
                    targetY = 20;
                    player.style.right = targetX + 'px';
                    player.style.bottom = targetY + 'px';
                    player.style.left = 'auto';
                    player.style.top = 'auto';
                }

                // Reset transform
                player.style.transform = 'translate(0, 0)';
                xOffset = 0;
                yOffset = 0;

                // Add subtle animation feedback
                player.style.boxShadow = '0 25px 80px rgba(0, 0, 0, 0.9), 0 0 50px rgba(59, 130, 246, 0.3)';
                setTimeout(() => {
                    player.style.boxShadow = '0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(59, 130, 246, 0.15)';
                }, 300);
            }

            // Add event listeners
            player.addEventListener('mousedown', dragStart);
            player.addEventListener('touchstart', dragStart);
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            
            // 🔧 ADD RESIZE FUNCTIONALITY
            addResizeFunctionality();
        }

        function addResizeFunctionality() {
            const player = document.getElementById('musicPlayerPopup');
            const resizeHandles = player.querySelectorAll('.resize-handle');
            
            let isResizing = false;
            let resizeType = '';
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;

            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
                handle.addEventListener('touchstart', startResize);
            });

            function startResize(e) {
                // Only start resize if user actually clicked on a resize handle
                if (!e.target.classList.contains('resize-handle')) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation(); // Prevent drag from triggering
                
                isResizing = true;
                resizeType = e.target.dataset.resize;
                
                const rect = player.getBoundingClientRect();
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                startWidth = parseInt(getComputedStyle(player).width, 10);
                startHeight = parseInt(getComputedStyle(player).height, 10);
                startLeft = rect.left;
                startTop = rect.top;
                
                player.style.transition = 'none';
                document.body.style.userSelect = 'none';
                
                console.log(`🔧 Resize started: ${resizeType}`);
                
                document.addEventListener('mousemove', doResize);
                document.addEventListener('touchmove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchend', stopResize);
            }

            function doResize(e) {
                if (!isResizing) return;
                
                const currentX = e.clientX || e.touches[0].clientX;
                const currentY = e.clientY || e.touches[0].clientY;
                
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                // Calculate new dimensions based on resize direction
                switch(resizeType) {
                    case 'se': // Bottom-right corner
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight + deltaY;
                        break;
                    case 'sw': // Bottom-left corner
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight + deltaY;
                        newLeft = startLeft + deltaX;
                        break;
                    case 'ne': // Top-right corner
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                        break;
                    case 'nw': // Top-left corner
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight - deltaY;
                        newLeft = startLeft + deltaX;
                        newTop = startTop + deltaY;
                        break;
                    case 'e': // Right border
                        newWidth = startWidth + deltaX;
                        break;
                    case 'w': // Left border
                        newWidth = startWidth - deltaX;
                        newLeft = startLeft + deltaX;
                        break;
                    case 's': // Bottom border
                        newHeight = startHeight + deltaY;
                        break;
                    case 'n': // Top border
                        newHeight = startHeight - deltaY;
                        newTop = startTop + deltaY;
                        break;
                }
                
                // Apply size constraints
                const minWidth = 300;
                const minHeight = 400;
                const maxWidth = 800;
                const maxHeight = 1000;
                
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));
                
                // Apply new dimensions
                player.style.width = newWidth + 'px';
                player.style.height = newHeight + 'px';
                player.style.left = newLeft + 'px';
                player.style.top = newTop + 'px';
                
                // Adjust content scaling for larger sizes
                adjustContentScaling(newWidth, newHeight);
            }

            function stopResize() {
                if (!isResizing) return;
                
                isResizing = false;
                resizeType = '';
                player.style.transition = 'all 0.3s ease';
                document.body.style.userSelect = '';
                
                console.log('🔧 Resize ended');
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('touchmove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchend', stopResize);
            }
            
            function adjustContentScaling(width, height) {
                // Scale content based on player size
                const baseWidth = 380;
                const baseHeight = 480;
                const scaleX = width / baseWidth;
                const scaleY = height / baseHeight;
                const scale = Math.min(scaleX, scaleY, 1.5); // Max 150% scale
                
                const albumArt = player.querySelector('.album-art');
                const songInfo = player.querySelector('.song-info');
                const controls = player.querySelector('.music-controls');
                
                if (albumArt) {
                    const baseArtSize = 180;
                    const newArtSize = Math.max(120, Math.min(250, baseArtSize * scale));
                    albumArt.style.width = newArtSize + 'px';
                    albumArt.style.height = newArtSize + 'px';
                }
                
                if (songInfo) {
                    songInfo.style.fontSize = Math.max(0.8, Math.min(1.2, scale)) + 'em';
                }
                
                if (controls) {
                    controls.style.fontSize = Math.max(0.9, Math.min(1.1, scale)) + 'em';
                }
            }
        }

        // Fix music player disappearing when switching tabs
        document.addEventListener('visibilitychange', () => {
            const popup = document.getElementById('musicPlayerPopup');
            const miniPlayer = document.getElementById('miniPlayer');
            
            if (document.hidden) {
                // Tab is hidden - store current state
                if (popup && popup.classList.contains('visible')) {
                    sessionStorage.setItem('musicPlayerVisible', 'true');
                }
                if (miniPlayer && miniPlayer.classList.contains('visible')) {
                    sessionStorage.setItem('miniPlayerVisible', 'true');
                }
            } else {
                // Tab is visible again - restore state
                setTimeout(() => {
                    if (sessionStorage.getItem('musicPlayerVisible') === 'true' && popup) {
                        popup.classList.add('visible');
                        const playerContent = document.getElementById('playerContent');
                        if (playerContent) playerContent.classList.add('visible');
                    }
                    if (sessionStorage.getItem('miniPlayerVisible') === 'true' && miniPlayer) {
                        miniPlayer.classList.add('visible');
                    }
                }, 100);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize header functionality
            initializeHeader();
            
            // Initialize draggable music player
            makeMusicPlayerDraggable();
            
            // Initialize music carousel first for immediate display
            initCarouselEarly();
            
            refreshStatus();
            refreshTextStatus();
            
            // Initialize visual settings
            updateVisualSettings();
            
            // Start periodic status updates
            statusUpdateInterval = setInterval(refreshStatus, 5000);
            textStatusUpdateInterval = setInterval(refreshTextStatus, 10000);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            if (emotionUpdateInterval) {
                clearInterval(emotionUpdateInterval);
            }
        });
    </script>

    <!-- Professional Music Player Popup -->
    <div id="musicPlayerPopup" class="music-player-popup">
        <!-- 🔧 RESIZE HANDLES -->
        <!-- Corner Handles -->
        <div class="resize-handle resize-corner resize-nw" data-resize="nw"></div>
        <div class="resize-handle resize-corner resize-ne" data-resize="ne"></div>
        <div class="resize-handle resize-corner resize-sw" data-resize="sw"></div>
        <div class="resize-handle resize-corner resize-se" data-resize="se"></div>
        
        <!-- Border Handles -->
        <div class="resize-handle resize-border resize-n" data-resize="n"></div>
        <div class="resize-handle resize-border resize-s" data-resize="s"></div>
        <div class="resize-handle resize-border resize-w" data-resize="w"></div>
        <div class="resize-handle resize-border resize-e" data-resize="e"></div>

        <!-- Wind Leaves Animation -->
        <div class="wind-animation" id="windAnimation">
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
            <div class="wind-particle"></div>
        </div>

        <!-- Loading Message -->
        <div class="loading-message" id="loadingMessage" style="display: none;">
            <div class="music-loading-icon">🎵</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>

        <!-- Player Content -->
        <div class="player-content" id="playerContent">
            <!-- Close Button -->
            <button class="close-player-btn" id="closePlayerBtn">✕</button>

            <!-- Album Art Section -->
            <div class="album-art-section">
                <div class="album-art" id="albumArt"></div>
            </div>

            <!-- Song Info -->
            <div class="song-info">
                <div class="song-title" id="songTitle">Select a song</div>
                <div class="song-artist" id="songArtist">Artist name</div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <!-- Player Controls -->
            <div class="player-controls">
                <button class="control-btn" id="prevBtn">⏮</button>
                <button class="control-btn play-pause-btn" id="playPauseBtn">▶</button>
                <button class="control-btn" id="nextBtn">⏭</button>
            </div>

            <!-- Volume Control -->
            <div class="volume-section">
                <span class="volume-icon">🔊</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>

            <!-- Hidden Audio Element -->
            <audio id="audioPlayer" preload="none"></audio>
        </div>
    </div>

    <!-- Minimized Music Player -->
    <div id="miniPlayer" class="mini-player">
        <div class="mini-album-art" id="miniAlbumArt"></div>
        <div class="mini-song-info">
            <div class="mini-song-title" id="miniSongTitle">Select a song</div>
            <div class="mini-song-artist" id="miniSongArtist">Artist name</div>
        </div>
        <div class="mini-controls">
            <button class="mini-control-btn" id="miniPrevBtn">⏮</button>
            <button class="mini-control-btn mini-play-pause-btn" id="miniPlayPauseBtn">▶</button>
            <button class="mini-control-btn" id="miniNextBtn">⏭</button>
            <button class="mini-control-btn mini-expand-btn" id="miniExpandBtn">⬆</button>
            <button class="mini-control-btn mini-close-btn" id="miniCloseBtn">✕</button>
        </div>
        <div class="mini-progress" id="miniProgress"></div>
    </div>

<!-- FOOTER START -->
<footer class="bg-gradient-to-r from-blue-700 to-blue-500 text-white py-8">
    <div class="container mx-auto px-4">
        <!-- Main Footer Content -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Company Info -->
            <div class="text-left">
                <h3 class="text-xl font-bold mb-3">AI Emotion Detection</h3>
                <p class="text-blue-100 mb-4">Transforming human-computer interaction through advanced emotional intelligence.</p>
                <div class="flex space-x-4 justify-start">
                    <!-- Social Media Icons -->
                    <a href="#" class="text-white hover:text-blue-200 transition-colors">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://www.linkedin.com/in/pallav-sharma" class="text-white hover:text-blue-200 transition-colors">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="https://github.com/pallav110" class="text-white hover:text-blue-200 transition-colors">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="text-left">
                <h3 class="text-xl font-bold mb-3">Quick Links</h3>
                <ul>
                    <li class="mb-2"><a href="/" class="text-blue-100 hover:text-white transition-colors">Home</a></li>
                    <li class="mb-2"><a href="/about" class="text-blue-100 hover:text-white transition-colors">About Us</a></li>
                    <li class="mb-2"><a href="/features" class="text-blue-100 hover:text-white transition-colors">Features</a></li>
                    <li class="mb-2"><a href="/pricing" class="text-blue-100 hover:text-white transition-colors">Pricing</a></li>
                    <li class="mb-2"><a href="/contact" class="text-blue-100 hover:text-white transition-colors">Contact</a></li>
                </ul>
            </div>
            
            <!-- Contact Info -->
            <div class="text-left">
                <h3 class="text-xl font-bold mb-3">Contact Us</h3>
                <p class="mb-2 flex items-center">
                    <i class="fas fa-envelope mr-2"></i>
                    <a href="mailto:pallavs2020@gmail.com" class="text-blue-100 hover:text-white transition-colors">pallavs2020@gmail.com</a>
                </p>
                <p class="mb-2 flex items-center">
                    <i class="fas fa-phone mr-2"></i>
                    <a href="tel:+918588999382" class="text-blue-100 hover:text-white transition-colors">+91 8588999382</a>
                </p>
                <p class="mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    <span class="text-blue-100">India, Noida-Delhi</span>
                </p>
                <a href="/contact" class="bg-white text-blue-600 font-medium px-4 py-2 rounded hover:bg-blue-100 transition-colors inline-block">Get in Touch</a>
            </div>
        </div>
        
        <!-- Divider -->
        <div class="border-t border-blue-400 my-4"></div>
        
        <!-- Bottom Footer -->
        <div class="flex flex-col md:flex-row justify-between items-center">
            <p>&copy; 2025 AI Emotion Detection. All rights reserved.</p>
            <div class="mt-2 md:mt-0">
                <a href="/privacy" class="text-sm text-blue-100 hover:text-white mr-4 transition-colors">Privacy Policy</a>
                <a href="/services" class="text-sm text-blue-100 hover:text-white mr-4 transition-colors">Terms of Service</a>
                <a href="/cookiepolicy" class="text-sm text-blue-100 hover:text-white transition-colors">Cookie Policy</a>
            </div>
        </div>
        
        <!-- Back to top button -->
        <div class="text-center mt-6">
            <a href="#top" class="inline-flex items-center text-blue-100 hover:text-white transition-colors">
                <span>Back to top</span>
                <i class="fas fa-chevron-up ml-1"></i>
            </a>
        </div>

    </div>
</footer>
<!-- FOOTER END -->

<!-- Font Awesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>

</body>
</html>