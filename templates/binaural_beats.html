<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binaural Beats Session | Y.M.I.R AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-black text-white font-primary overflow-x-hidden">
    <!-- Include Header -->
    {% include 'header.html' %}

    <!-- Main Content -->
    <main class="min-h-screen pt-20">
        <!-- Session Header -->
        <section class="py-12 px-6">
            <div class="max-w-4xl mx-auto">
                <!-- Back Navigation -->
                <div class="mb-8">
                    <a href="/experimental" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back to Experimental Home
                    </a>
                </div>

                <!-- Session Info -->
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">
                        <span class="bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
                            Binaural Beats Session
                        </span>
                    </h1>
                    <div id="goalDisplay" class="text-xl text-gray-300 mb-6">
                        <!-- Goal will be populated by JavaScript -->
                    </div>
                    
                    <!-- Headphones Requirement -->
                    <div class="bg-gradient-to-r from-blue-900/40 to-cyan-900/40 backdrop-blur-lg border border-blue-500/30 rounded-2xl p-6 max-w-2xl mx-auto">
                        <div class="flex items-center justify-center space-x-4">
                            <div class="text-3xl">🎧</div>
                            <div class="text-left">
                                <h3 class="text-lg font-semibold text-blue-300">Headphones Required</h3>
                                <p class="text-gray-300 text-sm">
                                    Binaural beats require stereo headphones to work properly. Each ear receives a slightly different frequency.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Session Control Panel -->
        <section class="py-8 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Control Panel -->
                    <div class="card-primary">
                        <h2 class="text-2xl font-bold mb-6 text-center text-blue-300">Session Controls</h2>
                        

                        <!-- Session Controls -->
                        <div class="space-y-4 mb-8">
                            <button id="startBtn" class="btn-primary w-full py-4 text-lg font-semibold">
                                Start Session
                            </button>
                            <button id="stopBtn" class="btn-danger w-full py-3 text-lg hidden">
                                Stop Session
                            </button>
                        </div>

                        <!-- Dual Volume Controls -->
                        <div class="space-y-6">
                            <!-- Foreground Music Volume -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">Foreground Music Volume</label>
                                <div class="flex items-center space-x-4">
                                    <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                    <input type="range" id="musicVolumeSlider" min="0" max="100" value="70" 
                                           class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </div>
                                <div class="text-center mt-2">
                                    <span id="musicVolumeDisplay" class="text-sm text-gray-400">Music: 70%</span>
                                </div>
                            </div>
                            
                            <!-- Binaural Beats Volume -->
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-3">Binaural Beats Volume</label>
                                <div class="flex items-center space-x-4">
                                    <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                    </svg>
                                    <input type="range" id="binauralVolumeSlider" min="0" max="100" value="30" 
                                           class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                    </svg>
                                </div>
                                <div class="text-center mt-2">
                                    <span id="binauralVolumeDisplay" class="text-sm text-gray-400">Binaural: 30%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Music Player & Frequency Panel -->
                    <div class="card-primary">
                        <!-- Spotify-Style Music Player -->
                        <div class="bg-gradient-to-r from-gray-900/80 to-gray-800/80 rounded-2xl p-6 mb-6 border border-purple-500/20">
                            <h2 class="text-xl font-bold mb-4 text-center text-purple-300">🎵 Music Player</h2>
                            
                            <!-- Album Art & Track Info -->
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center text-2xl shadow-lg">
                                    🎹
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div id="currentTrackName" class="text-white font-semibold truncate">Select a track</div>
                                    <div id="currentArtist" class="text-gray-400 text-sm truncate">No artist selected</div>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <div id="currentTime" class="text-xs text-gray-500">0:00</div>
                                        <div class="flex-1 h-1 bg-gray-700 rounded-full overflow-hidden">
                                            <div id="progressBar" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                                        </div>
                                        <div id="totalTime" class="text-xs text-gray-500">0:00</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Music Controls -->
                            <div class="flex items-center justify-center space-x-6 mb-4">
                                <button id="shuffleBtn" class="p-2 rounded-full hover:bg-purple-600/20 transition-colors text-gray-400 hover:text-purple-400">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                                    </svg>
                                </button>
                                <button id="prevBtn" class="p-2 rounded-full hover:bg-purple-600/20 transition-colors text-gray-300 hover:text-white">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                                    </svg>
                                </button>
                                <button id="musicPlayPauseBtn" class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center hover:scale-105 transition-transform shadow-lg">
                                    <svg id="musicPlayIcon" class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg id="musicPauseIcon" class="w-6 h-6 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                    </svg>
                                </button>
                                <button id="nextBtn" class="p-2 rounded-full hover:bg-purple-600/20 transition-colors text-gray-300 hover:text-white">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                                    </svg>
                                </button>
                                <button id="repeatBtn" class="p-2 rounded-full hover:bg-purple-600/20 transition-colors text-gray-400 hover:text-purple-400">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Enhanced Volume Control -->
                            <div class="flex items-center space-x-3">
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                                </svg>
                                <div class="flex-1">
                                    <input type="range" id="musicVolumeSlider" min="0" max="200" value="70" 
                                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-purple">
                                </div>
                                <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM3 9v6h4l5 5V4L7 9H3z"/>
                                </svg>
                                <div class="min-w-0">
                                    <span id="musicVolumeDisplay" class="text-sm text-purple-300 font-medium">70%</span>
                                </div>
                            </div>
                            
                            <!-- Track Selection -->
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-purple-300 mb-2">🎼 Choose Track</label>
                                <select id="musicSelect" class="w-full bg-gray-800/80 border border-purple-500/30 rounded-lg px-3 py-2 text-white focus:border-purple-400 focus:ring-2 focus:ring-purple-400/20">
                                    <option value="">🔇 No Background Music</option>
                                    <option value="ludovico-night">🌙 Ludovico Einaudi - Night</option>
                                    <option value="ludovico-nuvole" selected>☁️ Ludovico Einaudi - Nuvole Bianche</option>
                                    <option value="peder-you-me">💫 Peder B. Helland - You & Me</option>
                                    <option value="yiruma-river">🌊 Yiruma - River Flows in You</option>
                                </select>
                            </div>
                        </div>

                        <!-- Frequency Information -->
                        <div class="space-y-4">
                            <h3 class="text-xl font-bold text-center text-blue-300">🧠 Brainwave Frequency</h3>
                            
                            <!-- Current Frequency Display -->
                            <div class="bg-gradient-to-r from-blue-900/40 to-cyan-900/40 rounded-xl p-4 text-center">
                                <div id="currentFreq" class="text-2xl font-bold text-white mb-1">10.0 Hz</div>
                                <div id="freqType" class="text-cyan-300 font-semibold">Alpha Waves</div>
                                <div class="text-gray-400 text-sm mt-1">Target Brainwave Frequency</div>
                            </div>

                            <!-- Frequency Details -->
                            <div id="frequencyDetails" class="space-y-3">
                                <!-- Will be populated by JavaScript based on goal -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Status -->
                <div class="mt-8">
                    <div class="card-glass">
                        <div class="flex items-center justify-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
                                <span id="statusText" class="text-gray-300">Ready to Begin</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-xl">🎵</div>
                                <span id="audioStatus" class="text-gray-400">Audio: Not Playing</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Visualization -->
        <section class="py-8 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="card-primary">
                    <h3 class="text-xl font-bold mb-6 text-center text-cyan-300">Session Progress</h3>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-cyan-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                            <span>Start</span>
                            <span id="progressPercent">0%</span>
                            <span>Complete</span>
                        </div>
                    </div>

                    <!-- Pre/Post Session Questions (Hidden initially) -->
                    <div id="preSessionQuestions" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-blue-300">Pre-Session Assessment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Stress Level (1-10)</label>
                                <input type="range" id="preStress" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="preStressValue">5</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Focus Level (1-10)</label>
                                <input type="range" id="preFocus" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="preFocusValue">5</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="postSessionQuestions" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-green-300">Post-Session Assessment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Stress Level After Session (1-10)</label>
                                <input type="range" id="postStress" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="postStressValue">5</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Focus Level After Session (1-10)</label>
                                <input type="range" id="postFocus" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="postFocusValue">5</span></div>
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="submitAssessment" class="btn-primary">Submit Assessment</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hidden Audio Elements -->
        <!-- Foreground Music Audio -->
        <audio id="musicAudio" loop preload="auto" crossorigin="anonymous">
            <source id="musicSource" src="" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        
        <!-- Binaural Beats Audio -->
        <audio id="binauralAudio" loop preload="auto" crossorigin="anonymous">
            <source id="binauralSource" src="" type="audio/wav">
            Your browser does not support the audio element.
        </audio>
    </main>

    <!-- Include Footer -->
    {% include 'footer.html' %}

    <style>
        /* Y.M.I.R Theme Integration */
        :root {
            --primary-blue: #4070ff;
            --primary-cyan: #00d4ff;
            --bg-primary: #0c0c0c;
            --text-primary: #f0f0f0;
            --font-primary: 'Inter', 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(125deg, #000000, #0f172a, #1e293b);
        }

        /* Card System */
        .card-primary {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100, 100, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card-glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            padding: 16px;
        }

        /* Button System */
        .btn-primary {
            background: linear-gradient(45deg, #4070ff, #00d4ff);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(64, 112, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(64, 112, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(64, 112, 255, 0.3);
            border-radius: 12px;
            color: #f0f0f0;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .btn-secondary:hover, .btn-secondary.selected {
            background: rgba(64, 112, 255, 0.2);
            border-color: rgba(64, 112, 255, 0.6);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        /* Status Indicators */
        .status-ready { background-color: #6b7280; }
        .status-playing { background-color: #10b981; animation: pulse 2s infinite; }
        .status-paused { background-color: #f59e0b; }
        .status-stopped { background-color: #dc2626; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Enhanced Volume Slider Styling */
        input[type="range"] {
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4070ff, #00d4ff);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4070ff, #00d4ff);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Purple Music Player Slider */
        .slider-purple::-webkit-slider-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }

        .slider-purple::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #3b82f6);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
            transition: all 0.2s ease;
        }

        .slider-purple:hover::-webkit-slider-thumb {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.6);
        }

        .slider-purple::-moz-range-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
            border: none;
        }

        .slider-purple::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8b5cf6, #3b82f6);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        /* Music Player Enhancements */
        .music-player-card {
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
        }

        .track-progress {
            background: linear-gradient(90deg, #8b5cf6, #3b82f6);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        /* Hover effects for music controls */
        .music-control-btn {
            transition: all 0.2s ease;
        }

        .music-control-btn:hover {
            transform: translateY(-1px);
            filter: brightness(1.2);
        }

        .play-btn:hover {
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }

        /* Progress bar animation */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .progress-active {
            animation: progressPulse 2s infinite;
        }

        /* Volume indicator colors */
        .volume-low { color: #10b981; }
        .volume-medium { color: #f59e0b; }
        .volume-high { color: #ef4444; }
        .volume-extreme { color: #dc2626; font-weight: bold; }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get goal from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const goal = urlParams.get('goal') || 'focus';
            
            console.log('🚀 Starting binaural beats session for goal:', goal);
            
            // Session state
            let sessionActive = false;
            
            // DOM elements - declare before use
            let musicAudio, binauralAudio, musicSource, binauralSource;
            let startBtn, stopBtn, musicVolumeSlider, binauralVolumeSlider;
            let musicVolumeDisplay, binauralVolumeDisplay, musicSelect;
            let statusIndicator, statusText, audioStatus;
            
            // New music player elements
            let musicPlayPauseBtn, musicPlayIcon, musicPauseIcon;
            let currentTrackName, currentArtist, currentTime, totalTime;
            let progressBar, prevBtn, nextBtn, shuffleBtn, repeatBtn;
            
            // Initialize DOM elements
            function initializeDOMElements() {
                console.log('🔧 Initializing DOM elements...');
                
                // Audio elements
                musicAudio = document.getElementById('musicAudio');
                binauralAudio = document.getElementById('binauralAudio');
                musicSource = document.getElementById('musicSource');
                binauralSource = document.getElementById('binauralSource');
                
                // Control elements
                startBtn = document.getElementById('startBtn');
                stopBtn = document.getElementById('stopBtn');
                musicVolumeSlider = document.getElementById('musicVolumeSlider');
                binauralVolumeSlider = document.getElementById('binauralVolumeSlider');
                musicVolumeDisplay = document.getElementById('musicVolumeDisplay');
                binauralVolumeDisplay = document.getElementById('binauralVolumeDisplay');
                musicSelect = document.getElementById('musicSelect');
                statusIndicator = document.getElementById('statusIndicator');
                statusText = document.getElementById('statusText');
                audioStatus = document.getElementById('audioStatus');
                
                // New music player elements
                musicPlayPauseBtn = document.getElementById('musicPlayPauseBtn');
                musicPlayIcon = document.getElementById('musicPlayIcon');
                musicPauseIcon = document.getElementById('musicPauseIcon');
                currentTrackName = document.getElementById('currentTrackName');
                currentArtist = document.getElementById('currentArtist');
                currentTime = document.getElementById('currentTime');
                totalTime = document.getElementById('totalTime');
                progressBar = document.getElementById('progressBar');
                prevBtn = document.getElementById('prevBtn');
                nextBtn = document.getElementById('nextBtn');
                shuffleBtn = document.getElementById('shuffleBtn');
                repeatBtn = document.getElementById('repeatBtn');
                
                // Verify all elements exist
                const elements = {
                    musicAudio, binauralAudio, musicSource, binauralSource,
                    startBtn, stopBtn, musicVolumeSlider, binauralVolumeSlider,
                    musicVolumeDisplay, binauralVolumeDisplay, musicSelect,
                    statusIndicator, statusText, audioStatus,
                    musicPlayPauseBtn, musicPlayIcon, musicPauseIcon,
                    currentTrackName, currentArtist, currentTime, totalTime,
                    progressBar, prevBtn, nextBtn, shuffleBtn, repeatBtn
                };
                
                const missing = Object.entries(elements).filter(([name, element]) => !element);
                if (missing.length > 0) {
                    console.error('❌ Missing DOM elements:', missing.map(([name]) => name));
                    return false;
                }
                
                console.log('✅ All DOM elements initialized successfully');
                return true;
            }
            
            // Setup event listeners after DOM initialization
            function setupEventListeners() {
                console.log('🔗 Setting up event listeners...');
                
                // Session control listeners
                startBtn.addEventListener('click', startSession);
                stopBtn.addEventListener('click', stopSession);
            
                // Enhanced volume controls with color coding
                musicVolumeSlider.addEventListener('input', function() {
                    const volume = this.value;
                    let displayClass = 'volume-low';
                    let displayText = `${volume}%`;
                    
                    if (volume > 150) {
                        displayClass = 'volume-extreme';
                        displayText = `${volume}% ⚠️`;
                    } else if (volume > 100) {
                        displayClass = 'volume-high';
                        displayText = `${volume}% 🔥`;
                    } else if (volume > 75) {
                        displayClass = 'volume-medium';
                    }
                    
                    musicVolumeDisplay.textContent = displayText;
                    musicVolumeDisplay.className = `text-sm font-medium ${displayClass}`;
                    musicAudio.volume = Math.min(volume / 100, 2.0); // Cap at 200%
                });
                
                binauralVolumeSlider.addEventListener('input', function() {
                    const volume = this.value;
                    binauralVolumeDisplay.textContent = `Binaural: ${volume}%`;
                    binauralAudio.volume = volume / 100;
                });
                
                // Music player controls
                musicPlayPauseBtn.addEventListener('click', function() {
                    if (musicSelect.value) {
                        if (musicAudio.paused) {
                            musicAudio.play().then(() => {
                                updatePlayPauseIcon(false);
                            }).catch(console.error);
                        } else {
                            musicAudio.pause();
                            updatePlayPauseIcon(true);
                        }
                    } else {
                        alert('Please select a track first!');
                    }
                });
                
                // Previous/Next track buttons
                prevBtn.addEventListener('click', function() {
                    selectPreviousTrack();
                });
                
                nextBtn.addEventListener('click', function() {
                    selectNextTrack();
                });
                
                // Shuffle and repeat (placeholder functionality)
                shuffleBtn.addEventListener('click', function() {
                    this.classList.toggle('text-purple-400');
                    this.classList.toggle('text-gray-400');
                });
                
                repeatBtn.addEventListener('click', function() {
                    this.classList.toggle('text-purple-400');
                    this.classList.toggle('text-gray-400');
                    musicAudio.loop = !musicAudio.loop;
                });
                
                // Music selection - can change during session
                musicSelect.addEventListener('change', function() {
                    const selectedMusic = this.value;
                    const wasPlaying = !musicAudio.paused;
                    
                    if (selectedMusic) {
                        const musicPath = getMusicPath(selectedMusic);
                        const trackInfo = getTrackInfo(selectedMusic);
                        
                        musicSource.src = musicPath;
                        musicAudio.load();
                        
                        // Update track display
                        updateTrackDisplay(trackInfo);
                        
                        // If session is active, start playing the new music
                        if (sessionActive && wasPlaying) {
                            musicAudio.play().catch(console.error);
                        }
                    } else {
                        // Stop music if "No Background Music" is selected
                        musicAudio.pause();
                        updatePlayPauseIcon(true);
                        updateTrackDisplay({
                            name: 'Select a track',
                            artist: 'No artist selected'
                        });
                    }
                });
                
                // Audio time update
                musicAudio.addEventListener('timeupdate', function() {
                    updateProgress();
                });
                
                musicAudio.addEventListener('loadedmetadata', function() {
                    updateTotalTime();
                });
                
                musicAudio.addEventListener('play', function() {
                    updatePlayPauseIcon(false);
                    progressBar.classList.add('progress-active');
                });
                
                musicAudio.addEventListener('pause', function() {
                    updatePlayPauseIcon(true);
                    progressBar.classList.remove('progress-active');
                });
                
                musicAudio.addEventListener('ended', function() {
                    updatePlayPauseIcon(true);
                    progressBar.classList.remove('progress-active');
                    // Auto-play next track if repeat is off
                    if (!musicAudio.loop) {
                        selectNextTrack();
                    }
                });
                
                // Assessment slider handlers
                document.getElementById('preStress').addEventListener('input', function() {
                    document.getElementById('preStressValue').textContent = this.value;
                });
                
                document.getElementById('preFocus').addEventListener('input', function() {
                    document.getElementById('preFocusValue').textContent = this.value;
                });
                
                document.getElementById('postStress').addEventListener('input', function() {
                    document.getElementById('postStressValue').textContent = this.value;
                });
                
                document.getElementById('postFocus').addEventListener('input', function() {
                    document.getElementById('postFocusValue').textContent = this.value;
                });
                
                document.getElementById('submitAssessment').addEventListener('click', function() {
                    const assessmentData = {
                        goal: goal,
                        sessionType: 'binaural',
                        foregroundMusic: musicSelect.value,
                        preStress: document.getElementById('preStress').value,
                        preFocus: document.getElementById('preFocus').value,
                        postStress: document.getElementById('postStress').value,
                        postFocus: document.getElementById('postFocus').value,
                        completedAt: new Date().toISOString()
                    };
                    
                    // Save to localStorage (can be sent to backend later)
                    const sessions = JSON.parse(localStorage.getItem('ymirSessions') || '[]');
                    sessions.push(assessmentData);
                    localStorage.setItem('ymirSessions', JSON.stringify(sessions));
                    
                    alert('Assessment submitted! Thank you for your feedback.');
                    
                    // Hide assessment
                    document.getElementById('postSessionQuestions').classList.add('hidden');
                });
                
                console.log('✅ Event listeners setup complete');
            }
            
            function initializeSession(goal) {
                // Set goal display
                const goalDisplay = document.getElementById('goalDisplay');
                const goalInfo = getGoalInfo(goal);
                goalDisplay.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <span class="text-3xl">${goalInfo.emoji}</span>
                        <span class="text-2xl font-semibold">${goalInfo.name} Mode</span>
                    </div>
                `;
                
                // Set frequency information
                const currentFreq = document.getElementById('currentFreq');
                const freqType = document.getElementById('freqType');
                const frequencyDetails = document.getElementById('frequencyDetails');
                
                currentFreq.textContent = `${goalInfo.frequency} Hz`;
                freqType.textContent = goalInfo.waveType;
                
                frequencyDetails.innerHTML = `
                    <div class="bg-gradient-to-r from-gray-800/50 to-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold text-white mb-2">Target Effects:</h4>
                        <ul class="text-sm text-gray-300 space-y-1">
                            ${goalInfo.effects.map(effect => `<li>• ${effect}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-200 mb-2">How It Works:</h4>
                        <p class="text-sm text-blue-100">${goalInfo.description}</p>
                    </div>
                `;
                
                // Set binaural audio source based on goal
                const binauralPath = getBinauralPath(goal);
                console.log('🎧 Setting binaural path:', binauralPath);
                binauralSource.src = binauralPath;
                binauralAudio.load();
                
                // Set default music if selected
                if (musicSelect.value) {
                    const musicPath = getMusicPath(musicSelect.value);
                    const trackInfo = getTrackInfo(musicSelect.value);
                    console.log('🎼 Setting default music path:', musicPath);
                    musicSource.src = musicPath;
                    musicAudio.load();
                    updateTrackDisplay(trackInfo);
                } else {
                    console.log('ℹ️ No default music selected');
                    updateTrackDisplay({
                        name: 'Select a track',
                        artist: 'No artist selected'
                    });
                }
                
                // Set initial volumes
                musicAudio.volume = musicVolumeSlider.value / 100;
                binauralAudio.volume = binauralVolumeSlider.value / 100;
                
                console.log('Session initialized for goal:', goal);
                
                // Add error listeners for audio elements
                binauralAudio.addEventListener('error', function(e) {
                    console.error('Binaural audio error:', e.target.error);
                    alert('Error loading binaural audio. Please check the file path.');
                });
                
                musicAudio.addEventListener('error', function(e) {
                    console.error('Music audio error:', e.target.error);
                    alert('Error loading music. Please try a different track.');
                });
                
                // Add loaded event listeners for debugging
                binauralAudio.addEventListener('loadeddata', function() {
                    console.log('✅ Binaural audio loaded successfully');
                    console.log('   📁 Source:', binauralSource.src);
                    console.log('   ⏱️ Duration:', binauralAudio.duration);
                    console.log('   📊 Ready state:', binauralAudio.readyState);
                });
                
                binauralAudio.addEventListener('canplaythrough', function() {
                    console.log('✅ Binaural audio can play through');
                });
                
                musicAudio.addEventListener('loadeddata', function() {
                    console.log('✅ Music audio loaded successfully');
                    console.log('   📁 Source:', musicSource.src);
                    console.log('   ⏱️ Duration:', musicAudio.duration);
                    console.log('   📊 Ready state:', musicAudio.readyState);
                });
                
                musicAudio.addEventListener('canplaythrough', function() {
                    console.log('✅ Music audio can play through');
                });
            }
            
            function getGoalInfo(goal) {
                const goalMap = {
                    sleep: {
                        name: 'Deep Sleep',
                        emoji: '🌙',
                        frequency: '0.5-4',
                        waveType: 'Delta Waves',
                        effects: ['Deep restorative sleep', 'Enhanced dream recall', 'Physical recovery', 'Immune system boost'],
                        description: 'Delta waves (0.5-4Hz) are the slowest brainwaves associated with deep, dreamless sleep and physical restoration.'
                    },
                    focus: {
                        name: 'Enhanced Focus',
                        emoji: '🎯',
                        frequency: '12-30',
                        waveType: 'Beta Waves',
                        effects: ['Improved concentration', 'Enhanced mental clarity', 'Better problem solving', 'Increased alertness'],
                        description: 'Beta waves (12-30Hz) are associated with focused attention, analytical thinking, and active concentration.'
                    },
                    anxiety: {
                        name: 'Anxiety Relief',
                        emoji: '🕊️',
                        frequency: '8-12',
                        waveType: 'Alpha Waves',
                        effects: ['Reduced anxiety', 'Calmer mind', 'Stress relief', 'Emotional balance'],
                        description: 'Alpha waves (8-12Hz) promote a relaxed yet alert state, helping to reduce anxiety and stress.'
                    },
                    relaxation: {
                        name: 'Deep Relaxation',
                        emoji: '🧘',
                        frequency: '4-8',
                        waveType: 'Theta Waves',
                        effects: ['Deep relaxation', 'Meditation state', 'Inner peace', 'Stress reduction'],
                        description: 'Theta waves (4-8Hz) are associated with deep meditation, relaxation, and the subconscious mind.'
                    },
                    stress: {
                        name: 'Stress Reduction',
                        emoji: '⚡',
                        frequency: '8-12',
                        waveType: 'Alpha Waves',
                        effects: ['Lower cortisol levels', 'Reduced tension', 'Emotional balance', 'Mental calm'],
                        description: 'Alpha waves help activate the parasympathetic nervous system, promoting rest and recovery.'
                    },
                    creativity: {
                        name: 'Creative Flow',
                        emoji: '🎨',
                        frequency: '4-8',
                        waveType: 'Theta Waves',
                        effects: ['Enhanced creativity', 'Artistic inspiration', 'Flow state', 'Innovative thinking'],
                        description: 'Theta waves are linked to creative insights, artistic inspiration, and the flow state.'
                    }
                };
                
                return goalMap[goal] || goalMap.focus;
            }
            
            function getBinauralPath(goal) {
                // Map goals to frequency types and select appropriate binaural file
                const frequencyMap = {
                    sleep: 'delta',     // 0.5-4 Hz
                    focus: 'beta',      // 12-30 Hz
                    anxiety: 'alpha',   // 8-12 Hz
                    relaxation: 'theta', // 4-8 Hz
                    stress: 'alpha',    // 8-12 Hz
                    creativity: 'theta' // 4-8 Hz
                };
                
                const freqType = frequencyMap[goal] || 'alpha';
                // Use v1 version by default, could be randomized or user-selectable
                return `/experimental/binaural_tone/binaural_${freqType}_v1_${getFreqNumber(freqType)}Hz.wav`;
            }
            
            function getFreqNumber(freqType) {
                // Map frequency types to their file numbers
                const freqNumbers = {
                    delta: '241',
                    theta: '259', 
                    alpha: '257',
                    beta: '246',
                    gamma: '258'
                };
                return freqNumbers[freqType] || '257';
            }
            
            function getMusicPath(musicKey) {
                const musicMap = {
                    'ludovico-night': '/experimental/foreground_music/Ludovico Einaudi - Night (Official Video).mp3',
                    'ludovico-nuvole': '/experimental/foreground_music/Ludovico Einaudi - Nuvole Bianche.mp3',
                    'peder-you-me': '/experimental/foreground_music/Peder B. Helland - You & Me (Piano Version).mp3',
                    'yiruma-river': '/experimental/foreground_music/Yiruma, (이루마) - River Flows in You.mp3'
                };
                return musicMap[musicKey] || '';
            }
            
            function getTrackInfo(musicKey) {
                const trackMap = {
                    'ludovico-night': {
                        name: 'Night',
                        artist: 'Ludovico Einaudi'
                    },
                    'ludovico-nuvole': {
                        name: 'Nuvole Bianche',
                        artist: 'Ludovico Einaudi'
                    },
                    'peder-you-me': {
                        name: 'You & Me (Piano Version)',
                        artist: 'Peder B. Helland'
                    },
                    'yiruma-river': {
                        name: 'River Flows in You',
                        artist: 'Yiruma'
                    }
                };
                return trackMap[musicKey] || { name: 'Unknown Track', artist: 'Unknown Artist' };
            }
            
            function updateTrackDisplay(trackInfo) {
                currentTrackName.textContent = trackInfo.name;
                currentArtist.textContent = trackInfo.artist;
            }
            
            function updatePlayPauseIcon(isPaused) {
                if (isPaused) {
                    musicPlayIcon.classList.remove('hidden');
                    musicPauseIcon.classList.add('hidden');
                } else {
                    musicPlayIcon.classList.add('hidden');
                    musicPauseIcon.classList.remove('hidden');
                }
            }
            
            function updateProgress() {
                if (musicAudio.duration) {
                    const progress = (musicAudio.currentTime / musicAudio.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    currentTime.textContent = formatTime(musicAudio.currentTime);
                }
            }
            
            function updateTotalTime() {
                if (musicAudio.duration) {
                    totalTime.textContent = formatTime(musicAudio.duration);
                }
            }
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            function selectNextTrack() {
                const options = Array.from(musicSelect.options);
                const currentIndex = options.findIndex(option => option.value === musicSelect.value);
                const nextIndex = (currentIndex + 1) % options.length;
                
                // Skip "No Background Music" option
                if (options[nextIndex].value === '') {
                    const afterEmptyIndex = (nextIndex + 1) % options.length;
                    musicSelect.value = options[afterEmptyIndex].value;
                } else {
                    musicSelect.value = options[nextIndex].value;
                }
                
                // Trigger change event
                musicSelect.dispatchEvent(new Event('change'));
                
                // Auto-play if session is active
                if (sessionActive && musicSelect.value) {
                    musicAudio.play().catch(console.error);
                }
            }
            
            function selectPreviousTrack() {
                const options = Array.from(musicSelect.options);
                const currentIndex = options.findIndex(option => option.value === musicSelect.value);
                let prevIndex = currentIndex - 1;
                
                if (prevIndex < 0) {
                    prevIndex = options.length - 1;
                }
                
                // Skip "No Background Music" option
                if (options[prevIndex].value === '') {
                    prevIndex = prevIndex - 1;
                    if (prevIndex < 0) {
                        prevIndex = options.length - 1;
                    }
                }
                
                musicSelect.value = options[prevIndex].value;
                
                // Trigger change event
                musicSelect.dispatchEvent(new Event('change'));
                
                // Auto-play if session is active
                if (sessionActive && musicSelect.value) {
                    musicAudio.play().catch(console.error);
                }
            }
            
            async function startSession() {
                if (!sessionActive) {
                    try {
                        console.log('🚀 Starting binaural beats session...');
                        console.log('📊 Session state - sessionActive:', sessionActive);
                        console.log('🎵 Music selection:', musicSelect.value);
                        console.log('🧠 Binaural source:', binauralSource ? binauralSource.src : 'undefined');
                        console.log('🎼 Music source:', musicSource ? musicSource.src : 'undefined');
                        
                        // Check if audio elements are properly initialized
                        if (!binauralAudio || !musicAudio || !binauralSource || !musicSource) {
                            throw new Error('Audio elements not properly initialized');
                        }
                        
                        // Check if audio sources are set correctly
                        if (!binauralSource.src || binauralSource.src === window.location.href) {
                            throw new Error('Binaural audio source not set correctly');
                        }
                        
                        sessionActive = true;
                        
                        // Update UI immediately
                        startBtn.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        updateStatus('playing', 'Session Starting...');
                        
                        // Wait for binaural audio to be ready
                        console.log('⏯️ Attempting to play binaural beats...');
                        console.log('   📁 File path:', binauralSource.src);
                        console.log('   🔊 Volume:', binauralAudio.volume);
                        console.log('   ⏱️ Ready state:', binauralAudio.readyState);
                        
                        // Force reload if not ready
                        if (binauralAudio.readyState < 2) {
                            console.log('🔄 Reloading binaural audio...');
                            binauralAudio.load();
                            await new Promise(resolve => {
                                binauralAudio.addEventListener('canplay', resolve, { once: true });
                            });
                        }
                        
                        binauralAudio.currentTime = 0;
                        await binauralAudio.play();
                        console.log('✅ Binaural beats playing successfully!');
                        
                        // Start foreground music if selected
                        if (musicSelect.value && musicSource.src && musicSource.src !== window.location.href) {
                            console.log('⏯️ Attempting to play foreground music...');
                            console.log('   📁 File path:', musicSource.src);
                            console.log('   🔊 Volume:', musicAudio.volume);
                            console.log('   ⏱️ Ready state:', musicAudio.readyState);
                            
                            // Force reload if not ready
                            if (musicAudio.readyState < 2) {
                                console.log('🔄 Reloading music audio...');
                                musicAudio.load();
                                await new Promise(resolve => {
                                    musicAudio.addEventListener('canplay', resolve, { once: true });
                                });
                            }
                            
                            musicAudio.currentTime = 0;
                            await musicAudio.play();
                            console.log('✅ Foreground music playing successfully!');
                        } else {
                            console.log('ℹ️ No foreground music selected or source not set');
                        }
                        
                        updateStatus('playing', 'Session Active');
                        audioStatus.textContent = 'Audio: Playing';
                        console.log('🎉 Session started successfully!');
                        
                        // Show pre-session questions
                        document.getElementById('preSessionQuestions').classList.remove('hidden');
                        
                        // Debug audio states
                        setTimeout(() => {
                            console.log('🔍 Audio states after 1 second:');
                            console.log('   🧠 Binaural paused:', binauralAudio.paused);
                            console.log('   🧠 Binaural time:', binauralAudio.currentTime);
                            console.log('   🎼 Music paused:', musicAudio.paused);
                            console.log('   🎼 Music time:', musicAudio.currentTime);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('❌ Failed to start audio:', error);
                        console.error('   Error details:', {
                            name: error.name,
                            message: error.message,
                            stack: error.stack
                        });
                        
                        // More specific error messages
                        let userMessage = 'Failed to start audio. ';
                        if (error.name === 'NotAllowedError') {
                            userMessage += 'Please click somewhere on the page first to enable audio, then try again.';
                        } else if (error.name === 'AbortError') {
                            userMessage += 'Audio playback was interrupted. Please try again.';
                        } else if (error.name === 'NotSupportedError') {
                            userMessage += 'Your browser does not support the audio format.';
                        } else {
                            userMessage += error.message;
                        }
                        
                        alert(userMessage);
                        sessionActive = false;
                        
                        // Reset UI on error
                        startBtn.classList.remove('hidden');
                        stopBtn.classList.add('hidden');
                        updateStatus('stopped', 'Session Failed');
                        audioStatus.textContent = 'Audio: Error';
                    }
                }
            }
            
            function stopSession() {
                sessionActive = false;
                
                // Stop both audio tracks
                binauralAudio.pause();
                musicAudio.pause();
                
                // Reset UI
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                
                updateStatus('stopped', 'Session Stopped');
                audioStatus.textContent = 'Audio: Not Playing';
                
                // Show post-session questions
                document.getElementById('postSessionQuestions').classList.remove('hidden');
            }
            
            function updateStatus(status, text) {
                statusIndicator.className = `w-3 h-3 rounded-full status-${status}`;
                statusText.textContent = text;
            }
            
            // Initialize DOM elements first
            if (!initializeDOMElements()) {
                console.error('❌ Failed to initialize DOM elements');
                return;
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize session
            initializeSession(goal);
        });
    </script>
    
    <!-- Firebase Authentication -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth-styles.css') }}">
    <script src="{{ url_for('static', filename='js/firebase-auth.js') }}"></script>
    
</body>
</html>