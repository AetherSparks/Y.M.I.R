<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isochronic Tones Session | Y.M.I.R AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-black text-white font-primary overflow-x-hidden">
    <!-- Include Header -->
    {% include 'header.html' %}

    <!-- Main Content -->
    <main class="min-h-screen pt-20">
        <!-- Session Header -->
        <section class="py-12 px-6">
            <div class="max-w-4xl mx-auto">
                <!-- Back Navigation -->
                <div class="mb-8">
                    <a href="/experimental" class="inline-flex items-center text-purple-400 hover:text-purple-300 transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back to Experimental Home
                    </a>
                </div>

                <!-- Session Info -->
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">
                        <span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                            Isochronic Tones Session
                        </span>
                    </h1>
                    <div id="goalDisplay" class="text-xl text-gray-300 mb-6">
                        <!-- Goal will be populated by JavaScript -->
                    </div>
                    
                    <!-- Speakers Info -->
                    <div class="bg-gradient-to-r from-purple-900/40 to-pink-900/40 backdrop-blur-lg border border-purple-500/30 rounded-2xl p-6 max-w-2xl mx-auto">
                        <div class="flex items-center justify-center space-x-4">
                            <div class="text-3xl">üîä</div>
                            <div class="text-left">
                                <h3 class="text-lg font-semibold text-purple-300">Speakers or Headphones</h3>
                                <p class="text-gray-300 text-sm">
                                    Isochronic tones work with any audio setup. No stereo requirement - speakers are perfectly fine!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Session Control Panel -->
        <section class="py-8 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Control Panel -->
                    <div class="card-primary">
                        <h2 class="text-2xl font-bold mb-6 text-center text-purple-300">Session Controls</h2>
                        
                        <!-- Timer Display -->
                        <div class="text-center mb-8">
                            <div class="bg-gradient-to-r from-purple-900/40 to-pink-900/40 rounded-2xl p-8 mb-6">
                                <div id="timer" class="text-5xl font-mono font-bold text-white mb-2">25:00</div>
                                <div class="text-gray-400 text-sm">Session Time Remaining</div>
                            </div>
                            
                            <!-- Time Presets -->
                            <div class="grid grid-cols-4 gap-2 mb-6">
                                <button class="time-preset btn-secondary text-sm py-2" data-time="5">5 min</button>
                                <button class="time-preset btn-secondary text-sm py-2" data-time="15">15 min</button>
                                <button class="time-preset btn-secondary text-sm py-2 selected" data-time="25">25 min</button>
                                <button class="time-preset btn-secondary text-sm py-2" data-time="45">45 min</button>
                            </div>
                        </div>

                        <!-- Session Controls -->
                        <div class="space-y-4">
                            <button id="startBtn" class="btn-primary w-full py-4 text-lg font-semibold">
                                Start Session
                            </button>
                            <button id="pauseBtn" class="btn-secondary w-full py-4 text-lg font-semibold hidden">
                                Pause Session
                            </button>
                            <button id="stopBtn" class="btn-danger w-full py-3 text-lg hidden">
                                Stop Session
                            </button>
                        </div>

                        <!-- Volume Control -->
                        <div class="mt-8">
                            <label class="block text-sm font-medium text-gray-300 mb-3">Volume</label>
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl">üîà</span>
                                <input type="range" id="volumeSlider" min="0" max="100" value="50" 
                                       class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <span class="text-2xl">üîä</span>
                            </div>
                            <div class="text-center mt-2">
                                <span id="volumeDisplay" class="text-sm text-gray-400">Volume: 50%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Frequency Info Panel -->
                    <div class="card-primary">
                        <h2 class="text-2xl font-bold mb-6 text-center text-pink-300">Tone Information</h2>
                        
                        <!-- Current Frequency Display -->
                        <div class="bg-gradient-to-r from-pink-900/40 to-purple-900/40 rounded-2xl p-6 mb-6">
                            <div class="text-center">
                                <div id="currentFreq" class="text-3xl font-bold text-white mb-2">10.0 Hz</div>
                                <div id="freqType" class="text-pink-300 font-semibold">Alpha Rhythm</div>
                                <div class="text-gray-400 text-sm mt-2">Pulse Frequency</div>
                            </div>
                        </div>

                        <!-- Frequency Details -->
                        <div id="frequencyDetails" class="space-y-4">
                            <!-- Will be populated by JavaScript based on goal -->
                        </div>

                        <!-- Audio Settings -->
                        <div class="mt-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Carrier Frequency</label>
                                <select id="carrierFreqSelect" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="250">250 Hz (Low Tone)</option>
                                    <option value="400" selected>400 Hz (Medium Tone)</option>
                                    <option value="600">600 Hz (High Tone)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pulse Pattern</label>
                                <select id="pulsePattern" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="square">Sharp Pulses (Square Wave)</option>
                                    <option value="sine">Smooth Pulses (Sine Wave)</option>
                                    <option value="sawtooth">Rising Pulses (Sawtooth)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Duty Cycle</label>
                                <input type="range" id="dutyCycle" min="10" max="90" value="50" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">
                                    On/Off Ratio: <span id="dutyCycleValue">50%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Status -->
                <div class="mt-8">
                    <div class="card-glass">
                        <div class="flex items-center justify-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <div id="statusIndicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
                                <span id="statusText" class="text-gray-300">Ready to Begin</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-xl">üéµ</div>
                                <span id="audioStatus" class="text-gray-400">Audio: Not Playing</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-xl">‚ö°</div>
                                <span id="pulseRate" class="text-gray-400">Pulse: 0 Hz</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Visualization -->
        <section class="py-8 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="card-primary">
                    <h3 class="text-xl font-bold mb-6 text-center text-cyan-300">Session Progress</h3>
                    
                    <!-- Progress Bar -->
                    <div class="mb-6">
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                            <span>Start</span>
                            <span id="progressPercent">0%</span>
                            <span>Complete</span>
                        </div>
                    </div>

                    <!-- Pulse Visualizer -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-4 text-purple-300 text-center">Pulse Visualization</h4>
                        <div class="bg-gray-900 rounded-lg p-6 relative overflow-hidden" style="height: 120px;">
                            <canvas id="pulseCanvas" class="w-full h-full"></canvas>
                            <div id="pulseIndicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-purple-500 rounded-full opacity-0 transition-opacity duration-100"></div>
                        </div>
                    </div>

                    <!-- Pre/Post Session Questions (Hidden initially) -->
                    <div id="preSessionQuestions" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-purple-300">Pre-Session Assessment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Stress Level (1-10)</label>
                                <input type="range" id="preStress" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="preStressValue">5</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Current Focus Level (1-10)</label>
                                <input type="range" id="preFocus" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="preFocusValue">5</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="postSessionQuestions" class="hidden">
                        <h4 class="text-lg font-semibold mb-4 text-green-300">Post-Session Assessment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Stress Level After Session (1-10)</label>
                                <input type="range" id="postStress" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="postStressValue">5</span></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Focus Level After Session (1-10)</label>
                                <input type="range" id="postFocus" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-1 text-sm text-gray-400">Level: <span id="postFocusValue">5</span></div>
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="submitAssessment" class="btn-primary">Submit Assessment</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Hidden Audio Element -->
        <audio id="isochronicAudio" loop>
            <source src="/static/audio/isochronic_sample.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </main>

    <!-- Include Footer -->
    {% include 'footer.html' %}

    <style>
        /* Y.M.I.R Theme Integration */
        :root {
            --primary-purple: #9333ea;
            --primary-pink: #ec4899;
            --bg-primary: #0c0c0c;
            --text-primary: #f0f0f0;
            --font-primary: 'Inter', 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(125deg, #000000, #0f172a, #1e293b);
        }

        /* Card System */
        .card-primary {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 24px;
            transition: all 0.3s ease;
        }

        .card-glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            padding: 16px;
        }

        /* Button System */
        .btn-primary {
            background: linear-gradient(45deg, #9333ea, #ec4899);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(147, 51, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            color: #f0f0f0;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .btn-secondary:hover, .btn-secondary.selected {
            background: rgba(147, 51, 234, 0.2);
            border-color: rgba(147, 51, 234, 0.6);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        /* Status Indicators */
        .status-ready { background-color: #6b7280; }
        .status-playing { background-color: #9333ea; animation: pulse 2s infinite; }
        .status-paused { background-color: #f59e0b; }
        .status-stopped { background-color: #dc2626; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Pulse Indicator Animation */
        .pulse-active {
            animation: pulseGlow 0.5s ease-in-out;
        }

        @keyframes pulseGlow {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 0 10px rgba(147, 51, 234, 0.3);
            }
            100% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 20px rgba(147, 51, 234, 0);
            }
        }

        /* Volume Slider Styling */
        input[type="range"] {
            background: transparent;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9333ea, #ec4899);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-track {
            background: #374151;
            height: 8px;
            border-radius: 4px;
            border: none;
        }

        input[type="range"]::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9333ea, #ec4899);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get goal from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const goal = urlParams.get('goal') || 'focus';
            
            // Initialize session
            initializeSession(goal);
            
            // Session state
            let sessionActive = false;
            let sessionPaused = false;
            let sessionTimer = null;
            let currentTime = 1500; // 25 minutes default
            let totalTime = 1500;
            
            // Audio context for isochronic tones generation
            let audioContext = null;
            let oscillator = null;
            let gainNode = null;
            let pulseGainNode = null;
            let pulseTimer = null;
            
            // Canvas for pulse visualization
            let canvas = null;
            let ctx = null;
            
            // DOM elements
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const timer = document.getElementById('timer');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeDisplay = document.getElementById('volumeDisplay');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const audioStatus = document.getElementById('audioStatus');
            const pulseRate = document.getElementById('pulseRate');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const pulseIndicator = document.getElementById('pulseIndicator');
            const dutyCycle = document.getElementById('dutyCycle');
            const dutyCycleValue = document.getElementById('dutyCycleValue');
            
            // Initialize canvas
            canvas = document.getElementById('pulseCanvas');
            ctx = canvas.getContext('2d');
            
            // Event listeners
            startBtn.addEventListener('click', startSession);
            pauseBtn.addEventListener('click', pauseSession);
            stopBtn.addEventListener('click', stopSession);
            
            // Volume control
            volumeSlider.addEventListener('input', function() {
                const volume = this.value;
                volumeDisplay.textContent = `Volume: ${volume}%`;
                if (gainNode) {
                    gainNode.gain.value = volume / 100;
                }
            });
            
            // Duty cycle control
            dutyCycle.addEventListener('input', function() {
                dutyCycleValue.textContent = `${this.value}%`;
            });
            
            // Time presets
            document.querySelectorAll('.time-preset').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!sessionActive) {
                        document.querySelectorAll('.time-preset').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        const minutes = parseInt(this.dataset.time);
                        currentTime = minutes * 60;
                        totalTime = currentTime;
                        updateTimerDisplay();
                    }
                });
            });
            
            function initializeSession(goal) {
                // Set goal display
                const goalDisplay = document.getElementById('goalDisplay');
                const goalInfo = getGoalInfo(goal);
                goalDisplay.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <span class="text-3xl">${goalInfo.emoji}</span>
                        <span class="text-2xl font-semibold">${goalInfo.name} Mode</span>
                    </div>
                `;
                
                // Set frequency information
                const currentFreq = document.getElementById('currentFreq');
                const freqType = document.getElementById('freqType');
                const frequencyDetails = document.getElementById('frequencyDetails');
                
                currentFreq.textContent = `${goalInfo.frequency} Hz`;
                freqType.textContent = goalInfo.rhythmType;
                pulseRate.textContent = `Pulse: ${goalInfo.frequency} Hz`;
                
                frequencyDetails.innerHTML = `
                    <div class="bg-gradient-to-r from-gray-800/50 to-gray-700/50 rounded-lg p-4">
                        <h4 class="font-semibold text-white mb-2">Target Effects:</h4>
                        <ul class="text-sm text-gray-300 space-y-1">
                            ${goalInfo.effects.map(effect => `<li>‚Ä¢ ${effect}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-lg p-4">
                        <h4 class="font-semibold text-purple-200 mb-2">How It Works:</h4>
                        <p class="text-sm text-purple-100">${goalInfo.description}</p>
                    </div>
                `;
                
                // Initialize canvas
                setupCanvas();
            }
            
            function getGoalInfo(goal) {
                const goalMap = {
                    sleep: {
                        name: 'Deep Sleep',
                        emoji: 'üåô',
                        frequency: '2.0',
                        rhythmType: 'Delta Rhythm',
                        effects: ['Deep restorative sleep', 'Enhanced dream recall', 'Physical recovery', 'Reduced sleep latency'],
                        description: 'Delta rhythm pulses (0.5-4Hz) help synchronize brain activity for deep, restorative sleep cycles.'
                    },
                    focus: {
                        name: 'Enhanced Focus',
                        emoji: 'üéØ',
                        frequency: '20.0',
                        rhythmType: 'Beta Rhythm',
                        effects: ['Improved concentration', 'Enhanced mental clarity', 'Better task performance', 'Sustained attention'],
                        description: 'Beta rhythm pulses (13-30Hz) promote focused attention and analytical thinking through rhythmic stimulation.'
                    },
                    anxiety: {
                        name: 'Anxiety Relief',
                        emoji: 'üïäÔ∏è',
                        frequency: '10.0',
                        rhythmType: 'Alpha Rhythm',
                        effects: ['Reduced anxiety', 'Calmer mind', 'Stress relief', 'Emotional balance'],
                        description: 'Alpha rhythm pulses (8-12Hz) activate the relaxation response and calm the nervous system.'
                    },
                    relaxation: {
                        name: 'Deep Relaxation',
                        emoji: 'üßò',
                        frequency: '6.0',
                        rhythmType: 'Theta Rhythm',
                        effects: ['Deep relaxation', 'Meditation state', 'Inner peace', 'Muscle tension relief'],
                        description: 'Theta rhythm pulses (4-8Hz) induce deep meditative states and profound relaxation.'
                    },
                    stress: {
                        name: 'Stress Reduction',
                        emoji: '‚ö°',
                        frequency: '8.0',
                        rhythmType: 'Alpha Rhythm',
                        effects: ['Lower cortisol levels', 'Reduced tension', 'Emotional balance', 'Mental calm'],
                        description: 'Alpha rhythm pulses help activate the parasympathetic nervous system for stress recovery.'
                    },
                    creativity: {
                        name: 'Creative Flow',
                        emoji: 'üé®',
                        frequency: '6.0',
                        rhythmType: 'Theta Rhythm',
                        effects: ['Enhanced creativity', 'Artistic inspiration', 'Flow state', 'Innovative thinking'],
                        description: 'Theta rhythm pulses facilitate creative insights and artistic inspiration through subconscious activation.'
                    }
                };
                
                return goalMap[goal] || goalMap.focus;
            }
            
            function setupCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // Draw initial grid
                drawGrid();
            }
            
            function drawGrid() {
                ctx.strokeStyle = 'rgba(147, 51, 234, 0.2)';
                ctx.lineWidth = 1;
                
                // Horizontal lines
                for (let i = 0; i <= 4; i++) {
                    const y = (canvas.height / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // Vertical lines
                for (let i = 0; i <= 10; i++) {
                    const x = (canvas.width / 10) * i;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
            }
            
            async function startSession() {
                if (!sessionActive) {
                    // Show pre-session questions
                    document.getElementById('preSessionQuestions').classList.remove('hidden');
                    
                    // Initialize Web Audio API
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        await createIsochronicTones();
                        
                        sessionActive = true;
                        sessionPaused = false;
                        
                        // Update UI
                        startBtn.classList.add('hidden');
                        pauseBtn.classList.remove('hidden');
                        stopBtn.classList.remove('hidden');
                        
                        updateStatus('playing', 'Session Active');
                        audioStatus.textContent = 'Audio: Isochronic Tones Playing';
                        
                        // Start timer and pulse visualization
                        sessionTimer = setInterval(updateTimer, 1000);
                        startPulseVisualization();
                        
                    } catch (error) {
                        console.error('Failed to start audio:', error);
                        alert('Failed to start audio. Please check your browser settings.');
                    }
                } else if (sessionPaused) {
                    // Resume
                    audioContext.resume();
                    sessionPaused = false;
                    
                    pauseBtn.textContent = 'Pause Session';
                    updateStatus('playing', 'Session Active');
                    sessionTimer = setInterval(updateTimer, 1000);
                    startPulseVisualization();
                }
            }
            
            function pauseSession() {
                if (sessionActive && !sessionPaused) {
                    audioContext.suspend();
                    sessionPaused = true;
                    
                    pauseBtn.textContent = 'Resume Session';
                    updateStatus('paused', 'Session Paused');
                    clearInterval(sessionTimer);
                    stopPulseVisualization();
                }
            }
            
            function stopSession() {
                sessionActive = false;
                sessionPaused = false;
                
                // Stop audio
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // Reset UI
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                stopBtn.classList.add('hidden');
                pauseBtn.textContent = 'Pause Session';
                
                updateStatus('stopped', 'Session Stopped');
                audioStatus.textContent = 'Audio: Not Playing';
                
                // Clear timers
                clearInterval(sessionTimer);
                stopPulseVisualization();
                
                // Show post-session questions
                document.getElementById('postSessionQuestions').classList.remove('hidden');
                
                // Reset timer
                currentTime = totalTime;
                updateTimerDisplay();
                updateProgress();
            }
            
            async function createIsochronicTones() {
                const goalInfo = getGoalInfo(new URLSearchParams(window.location.search).get('goal') || 'focus');
                const carrierFreq = parseInt(document.getElementById('carrierFreqSelect').value);
                const pulseFreq = parseFloat(goalInfo.frequency);
                const waveType = document.getElementById('pulsePattern').value;
                
                // Create carrier oscillator
                oscillator = audioContext.createOscillator();
                oscillator.frequency.value = carrierFreq;
                oscillator.type = 'sine';
                
                // Create gain nodes
                gainNode = audioContext.createGain();
                pulseGainNode = audioContext.createGain();
                gainNode.gain.value = volumeSlider.value / 100;
                pulseGainNode.gain.value = 0; // Start silent
                
                // Connect audio graph
                oscillator.connect(pulseGainNode);
                pulseGainNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Start oscillator
                oscillator.start();
                
                // Start pulse modulation
                startPulseModulation(pulseFreq);
            }
            
            function startPulseModulation(frequency) {
                const period = 1 / frequency; // seconds per cycle
                const dutyCyclePercent = parseInt(dutyCycle.value);
                const onTime = (period * dutyCyclePercent) / 100;
                const offTime = period - onTime;
                
                function pulse() {
                    if (sessionActive && !sessionPaused) {
                        // Turn on
                        pulseGainNode.gain.setValueAtTime(1, audioContext.currentTime);
                        
                        // Visual pulse indication
                        triggerPulseVisualization();
                        
                        // Turn off after onTime
                        setTimeout(() => {
                            if (pulseGainNode) {
                                pulseGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                            }
                        }, onTime * 1000);
                        
                        // Schedule next pulse
                        pulseTimer = setTimeout(pulse, period * 1000);
                    }
                }
                
                pulse();
            }
            
            function startPulseVisualization() {
                const goalInfo = getGoalInfo(new URLSearchParams(window.location.search).get('goal') || 'focus');
                const frequency = parseFloat(goalInfo.frequency);
                
                // Update pulse rate display
                pulseRate.textContent = `Pulse: ${frequency} Hz`;
            }
            
            function stopPulseVisualization() {
                if (pulseTimer) {
                    clearTimeout(pulseTimer);
                }
            }
            
            function triggerPulseVisualization() {
                // Visual pulse indicator
                pulseIndicator.classList.remove('pulse-active');
                setTimeout(() => {
                    pulseIndicator.classList.add('pulse-active');
                }, 10);
                
                // Canvas visualization
                drawPulse();
            }
            
            function drawPulse() {
                // Clear and redraw grid
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawGrid();
                
                // Draw pulse wave
                ctx.strokeStyle = '#ec4899';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                const amplitude = canvas.height * 0.3;
                const centerY = canvas.height / 2;
                const time = Date.now() / 1000;
                
                for (let x = 0; x < canvas.width; x++) {
                    const goalInfo = getGoalInfo(new URLSearchParams(window.location.search).get('goal') || 'focus');
                    const frequency = parseFloat(goalInfo.frequency);
                    const t = (x / canvas.width) * 4; // 4 seconds worth
                    const y = centerY + amplitude * Math.sin(2 * Math.PI * frequency * (t + time));
                    
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.stroke();
            }
            
            function updateTimer() {
                if (currentTime > 0) {
                    currentTime--;
                    updateTimerDisplay();
                    updateProgress();
                } else {
                    // Session complete
                    stopSession();
                    alert('Session completed! Please complete the post-session assessment.');
                }
            }
            
            function updateTimerDisplay() {
                const minutes = Math.floor(currentTime / 60);
                const seconds = currentTime % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            function updateProgress() {
                const progress = ((totalTime - currentTime) / totalTime) * 100;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
            }
            
            function updateStatus(status, text) {
                statusIndicator.className = `w-3 h-3 rounded-full status-${status}`;
                statusText.textContent = text;
            }
            
            // Assessment slider handlers
            document.getElementById('preStress').addEventListener('input', function() {
                document.getElementById('preStressValue').textContent = this.value;
            });
            
            document.getElementById('preFocus').addEventListener('input', function() {
                document.getElementById('preFocusValue').textContent = this.value;
            });
            
            document.getElementById('postStress').addEventListener('input', function() {
                document.getElementById('postStressValue').textContent = this.value;
            });
            
            document.getElementById('postFocus').addEventListener('input', function() {
                document.getElementById('postFocusValue').textContent = this.value;
            });
            
            document.getElementById('submitAssessment').addEventListener('click', function() {
                // Collect assessment data
                const assessmentData = {
                    goal: new URLSearchParams(window.location.search).get('goal'),
                    sessionType: 'isochronic',
                    preStress: document.getElementById('preStress').value,
                    preFocus: document.getElementById('preFocus').value,
                    postStress: document.getElementById('postStress').value,
                    postFocus: document.getElementById('postFocus').value,
                    sessionDuration: totalTime,
                    completedAt: new Date().toISOString()
                };
                
                // Save to localStorage (can be sent to backend later)
                const sessions = JSON.parse(localStorage.getItem('ymirSessions') || '[]');
                sessions.push(assessmentData);
                localStorage.setItem('ymirSessions', JSON.stringify(sessions));
                
                alert('Assessment submitted! Thank you for your feedback.');
                
                // Hide assessment
                document.getElementById('postSessionQuestions').classList.add('hidden');
            });
            
            // Initialize timer display
            updateTimerDisplay();
            
            // Resize canvas when window resizes
            window.addEventListener('resize', setupCanvas);
        });
    </script>
    
    <!-- Firebase Authentication -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth-styles.css') }}">
    <script src="{{ url_for('static', filename='js/firebase-auth.js') }}"></script>
    
</body>
</html>